<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GPGPU-Sim: v3.x/src/gpgpu-sim/l2cache.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_c934b74ccb33d6b9bfd1e576787940d8.html">v3.x</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_da58ad9beee6988f697f1a76e412a52a.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_d956d62670f5e9a38a62eba10b09b5c2.html">gpgpu-sim</a>
  </div>
</div>
<div class="contents">
<h1>l2cache.cc</h1><a href="l2cache_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// Copyright (c) 2009-2011, Tor M. Aamodt</span>
<a name="l00002"></a>00002 <span class="comment">// The University of British Columbia</span>
<a name="l00003"></a>00003 <span class="comment">// All rights reserved.</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// Redistribution and use in source and binary forms, with or without</span>
<a name="l00006"></a>00006 <span class="comment">// modification, are permitted provided that the following conditions are met:</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// Redistributions of source code must retain the above copyright notice, this</span>
<a name="l00009"></a>00009 <span class="comment">// list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment">// Redistributions in binary form must reproduce the above copyright notice, this</span>
<a name="l00011"></a>00011 <span class="comment">// list of conditions and the following disclaimer in the documentation and/or</span>
<a name="l00012"></a>00012 <span class="comment">// other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment">// Neither the name of The University of British Columbia nor the names of its</span>
<a name="l00014"></a>00014 <span class="comment">// contributors may be used to endorse or promote products derived from this</span>
<a name="l00015"></a>00015 <span class="comment">// software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment">//</span>
<a name="l00017"></a>00017 <span class="comment">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<a name="l00018"></a>00018 <span class="comment">// ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<a name="l00019"></a>00019 <span class="comment">// WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<a name="l00020"></a>00020 <span class="comment">// DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<a name="l00021"></a>00021 <span class="comment">// FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a name="l00022"></a>00022 <span class="comment">// DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<a name="l00023"></a>00023 <span class="comment">// SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00024"></a>00024 <span class="comment">// CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00025"></a>00025 <span class="comment">// OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00026"></a>00026 <span class="comment">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;set&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;../option_parser.h&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="mem__fetch_8h.html">mem_fetch.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="dram_8h.html">dram.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="gpu-cache_8h.html">gpu-cache.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="histogram_8h.html">histogram.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="l2cache_8h.html">l2cache.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;../statwrapper.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;../abstract_hardware_model.h&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="gpu-sim_8h.html">gpu-sim.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="shader_8h.html">shader.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="mem__latency__stat_8h.html">mem_latency_stat.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="l2cache__trace_8h.html">l2cache_trace.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="classpartition__mf__allocator.html#a7f60fc56522bcfd33fac5af1db84dc70">00049</a> <a class="code" href="classmem__fetch.html">mem_fetch</a> * <a class="code" href="classpartition__mf__allocator.html#a675ca61f38253710f9720ef5acb66c4e">partition_mf_allocator::alloc</a>(<a class="code" href="abstract__hardware__model_8h.html#adcde2e548bc855c5cb446e23e38bd12d">new_addr_type</a> addr, mem_access_type type, <span class="keywordtype">unsigned</span> size, <span class="keywordtype">bool</span> wr )<span class="keyword"> const </span>
<a name="l00050"></a>00050 <span class="keyword"></span>{
<a name="l00051"></a>00051     assert( wr );
<a name="l00052"></a>00052     <a class="code" href="classmem__access__t.html">mem_access_t</a> access( type, addr, size, wr );
<a name="l00053"></a>00053     <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = <span class="keyword">new</span> <a class="code" href="classmem__fetch.html">mem_fetch</a>( access, 
<a name="l00054"></a>00054                                    NULL,
<a name="l00055"></a>00055                                    WRITE_PACKET_SIZE, 
<a name="l00056"></a>00056                                    -1, 
<a name="l00057"></a>00057                                    -1, 
<a name="l00058"></a>00058                                    -1,
<a name="l00059"></a>00059                                    <a class="code" href="classpartition__mf__allocator.html#a48c6a04c06caa7c28d47919df38d7920">m_memory_config</a> );
<a name="l00060"></a>00060     <span class="keywordflow">return</span> mf;
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="classmemory__partition__unit.html#a9138a3051171a0c613d7db7d7902e1d1">00063</a> <a class="code" href="classmemory__partition__unit.html#a9138a3051171a0c613d7db7d7902e1d1">memory_partition_unit::memory_partition_unit</a>( <span class="keywordtype">unsigned</span> partition_id, 
<a name="l00064"></a>00064                                               <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmemory__config.html">memory_config</a> *config,
<a name="l00065"></a>00065                                               <span class="keyword">class</span> <a class="code" href="classmemory__stats__t.html">memory_stats_t</a> *stats )
<a name="l00066"></a>00066 : m_id(partition_id), m_config(config), m_stats(stats), m_arbitration_metadata(config) 
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a> = <span class="keyword">new</span> <a class="code" href="classdram__t.html">dram_t</a>(<a class="code" href="classmemory__partition__unit.html#a927053f13b600a75da9a56a996768b84">m_id</a>,<a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>,<a class="code" href="classmemory__partition__unit.html#ae6039192424f35c3691d13f4d4dbc08b">m_stats</a>,<span class="keyword">this</span>);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a> = <span class="keyword">new</span> <a class="code" href="classmemory__sub__partition.html">memory_sub_partition</a>*[<a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>]; 
<a name="l00071"></a>00071     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00072"></a>00072         <span class="keywordtype">unsigned</span> sub_partition_id = <a class="code" href="classmemory__partition__unit.html#a927053f13b600a75da9a56a996768b84">m_id</a> * <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a> + p; 
<a name="l00073"></a>00073         <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[p] = <span class="keyword">new</span> <a class="code" href="classmemory__sub__partition.html">memory_sub_partition</a>(sub_partition_id, <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>, stats); 
<a name="l00074"></a>00074     }
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="classmemory__partition__unit.html#a80e990492df06752c8740bff51ea44e3">00077</a> <a class="code" href="classmemory__partition__unit.html#a80e990492df06752c8740bff51ea44e3">memory_partition_unit::~memory_partition_unit</a>() 
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     <span class="keyword">delete</span> <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>; 
<a name="l00080"></a>00080     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00081"></a>00081         <span class="keyword">delete</span> <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[p]; 
<a name="l00082"></a>00082     } 
<a name="l00083"></a>00083     <span class="keyword">delete</span>[] <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>; 
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae49da0a6d8695f9668795afec4e81891">00086</a> <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae49da0a6d8695f9668795afec4e81891">memory_partition_unit::arbitration_metadata::arbitration_metadata</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmemory__config.html">memory_config</a> *config) 
<a name="l00087"></a>00087 : m_last_borrower(config-&gt;m_n_sub_partition_per_memory_channel - 1), 
<a name="l00088"></a>00088   m_private_credit(config-&gt;m_n_sub_partition_per_memory_channel, 0), 
<a name="l00089"></a>00089   m_shared_credit(0) 
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     <span class="comment">// each sub partition get at least 1 credit for forward progress </span>
<a name="l00092"></a>00092     <span class="comment">// the rest is shared among with other partitions </span>
<a name="l00093"></a>00093     <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a4a0683d07cbc62065a8871cc1f0fa625">m_private_credit_limit</a> = 1; 
<a name="l00094"></a>00094     <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a> = config-&gt;<a class="code" href="structmemory__config.html#ac79cf2200f52166c66c75d5a055a84d7">gpgpu_frfcfs_dram_sched_queue_size</a> 
<a name="l00095"></a>00095                             + config-&gt;<a class="code" href="structmemory__config.html#a7adb7ff206e0a67d9d5a6c37562c3d0b">gpgpu_dram_return_queue_size</a> 
<a name="l00096"></a>00096                             - (config-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a> - 1); 
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structmemory__config.html#ac79cf2200f52166c66c75d5a055a84d7">gpgpu_frfcfs_dram_sched_queue_size</a> == 0 
<a name="l00098"></a>00098         or config-&gt;<a class="code" href="structmemory__config.html#a7adb7ff206e0a67d9d5a6c37562c3d0b">gpgpu_dram_return_queue_size</a> == 0) 
<a name="l00099"></a>00099     {
<a name="l00100"></a>00100         <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a> = 0; <span class="comment">// no limit if either of the queue has no limit in size </span>
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102     assert(<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a> &gt;= 0); 
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a7d00c343c8445c53a00fec4ad8a8a89d">00105</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a7d00c343c8445c53a00fec4ad8a8a89d">memory_partition_unit::arbitration_metadata::has_credits</a>(<span class="keywordtype">int</span> inner_sub_partition_id)<span class="keyword"> const </span>
<a name="l00106"></a>00106 <span class="keyword"></span>{
<a name="l00107"></a>00107     <span class="keywordtype">int</span> spid = inner_sub_partition_id; 
<a name="l00108"></a>00108     <span class="keywordflow">if</span> (<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>[spid] &lt; <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a4a0683d07cbc62065a8871cc1f0fa625">m_private_credit_limit</a>) {
<a name="l00109"></a>00109         <span class="keywordflow">return</span> <span class="keyword">true</span>; 
<a name="l00110"></a>00110     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a> == 0 || <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a82c06756efe3f72ae4d4e192fb1c4aef">m_shared_credit</a> &lt; <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a>) {
<a name="l00111"></a>00111         <span class="keywordflow">return</span> <span class="keyword">true</span>; 
<a name="l00112"></a>00112     } <span class="keywordflow">else</span> {
<a name="l00113"></a>00113         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#adc4be6e2878e31f7ed415685c1f5e719">00117</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#adc4be6e2878e31f7ed415685c1f5e719">memory_partition_unit::arbitration_metadata::borrow_credit</a>(<span class="keywordtype">int</span> inner_sub_partition_id) 
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119     <span class="keywordtype">int</span> spid = inner_sub_partition_id; 
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>[spid] &lt; <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a4a0683d07cbc62065a8871cc1f0fa625">m_private_credit_limit</a>) {
<a name="l00121"></a>00121         <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>[spid] += 1; 
<a name="l00122"></a>00122     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a> == 0 || <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a82c06756efe3f72ae4d4e192fb1c4aef">m_shared_credit</a> &lt; <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a>) {
<a name="l00123"></a>00123         <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a82c06756efe3f72ae4d4e192fb1c4aef">m_shared_credit</a> += 1; 
<a name="l00124"></a>00124     } <span class="keywordflow">else</span> {
<a name="l00125"></a>00125         assert(0 &amp;&amp; <span class="stringliteral">&quot;DRAM arbitration error: Borrowing from depleted credit!&quot;</span>); 
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127     <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a58b8c39885ee32d50390c840b93b8750">m_last_borrower</a> = spid; 
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ade9f55f83d3ff6fe6b44adc43920b7dd">00130</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ade9f55f83d3ff6fe6b44adc43920b7dd">memory_partition_unit::arbitration_metadata::return_credit</a>(<span class="keywordtype">int</span> inner_sub_partition_id) 
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     <span class="keywordtype">int</span> spid = inner_sub_partition_id; 
<a name="l00133"></a>00133     <span class="keywordflow">if</span> (<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>[spid] &gt; 0) {
<a name="l00134"></a>00134         <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>[spid] -= 1; 
<a name="l00135"></a>00135     } <span class="keywordflow">else</span> {
<a name="l00136"></a>00136         <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a82c06756efe3f72ae4d4e192fb1c4aef">m_shared_credit</a> -= 1; 
<a name="l00137"></a>00137     } 
<a name="l00138"></a>00138     assert((<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a82c06756efe3f72ae4d4e192fb1c4aef">m_shared_credit</a> &gt;= 0) &amp;&amp; <span class="stringliteral">&quot;DRAM arbitration error: Returning more than available credits!&quot;</span>); 
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#aa33f311f1fde834baebdbaa644d1a5e8">00141</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a3e9c697307e08cdc0da97a7dc777a211">memory_partition_unit::arbitration_metadata::print</a>( FILE *fp )<span class="keyword"> const </span>
<a name="l00142"></a>00142 <span class="keyword"></span>{
<a name="l00143"></a>00143     fprintf(fp, <span class="stringliteral">&quot;private_credit = &quot;</span>); 
<a name="l00144"></a>00144     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>.size(); p++) {
<a name="l00145"></a>00145         fprintf(fp, <span class="stringliteral">&quot;%d &quot;</span>, <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a013fc50c9d0c5d0a16b50bdc0b2614e8">m_private_credit</a>[p]); 
<a name="l00146"></a>00146     }
<a name="l00147"></a>00147     fprintf(fp, <span class="stringliteral">&quot;(limit = %d)\n&quot;</span>, <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a4a0683d07cbc62065a8871cc1f0fa625">m_private_credit_limit</a>); 
<a name="l00148"></a>00148     fprintf(fp, <span class="stringliteral">&quot;shared_credit = %d (limit = %d)\n&quot;</span>, <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a82c06756efe3f72ae4d4e192fb1c4aef">m_shared_credit</a>, <a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ae4610bdb30c585d9d8566d93195c4a1b">m_shared_credit_limit</a>); 
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="classmemory__partition__unit.html#ad03349e1023a6bc4da19f271dfc92327">00151</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__partition__unit.html#ad03349e1023a6bc4da19f271dfc92327">memory_partition_unit::busy</a>()<span class="keyword"> const </span>
<a name="l00152"></a>00152 <span class="keyword"></span>{
<a name="l00153"></a>00153     <span class="keywordtype">bool</span> <a class="code" href="classmemory__partition__unit.html#ad03349e1023a6bc4da19f271dfc92327">busy</a> = <span class="keyword">false</span>; 
<a name="l00154"></a>00154     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00155"></a>00155         <span class="keywordflow">if</span> (<a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[p]-&gt;<a class="code" href="classmemory__partition__unit.html#ad03349e1023a6bc4da19f271dfc92327">busy</a>()) {
<a name="l00156"></a>00156             busy = <span class="keyword">true</span>; 
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159     <span class="keywordflow">return</span> busy; 
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a><a class="code" href="classmemory__partition__unit.html#a90acc7762469d66da031535ae0593f87">00162</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a90acc7762469d66da031535ae0593f87">memory_partition_unit::cache_cycle</a>(<span class="keywordtype">unsigned</span> cycle) 
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00165"></a>00165         <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[p]-&gt;<a class="code" href="classmemory__sub__partition.html#a00e9b1e998aea1895ff9898e5ac3ae83">cache_cycle</a>(cycle); 
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="classmemory__partition__unit.html#a9b7d2af302fe19b75953217ecd874947">00169</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a9b7d2af302fe19b75953217ecd874947">memory_partition_unit::visualizer_print</a>( gzFile visualizer_file )<span class="keyword"> const </span>
<a name="l00170"></a>00170 <span class="keyword"></span>{
<a name="l00171"></a>00171     <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#abca0a824f3b569d7714207f79a6191ca">visualizer_print</a>(visualizer_file);
<a name="l00172"></a>00172     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00173"></a>00173         <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[p]-&gt;<a class="code" href="classmemory__sub__partition.html#a015bc320ef6092ce1ec1c4dd28af6b34">visualizer_print</a>(visualizer_file); 
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">// determine whether a given subpartition can issue to DRAM </span>
<a name="l00178"></a><a class="code" href="classmemory__partition__unit.html#a56f713a5a000a23a72e115dd7cb41104">00178</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__partition__unit.html#a56f713a5a000a23a72e115dd7cb41104">memory_partition_unit::can_issue_to_dram</a>(<span class="keywordtype">int</span> inner_sub_partition_id) 
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180     <span class="keywordtype">int</span> spid = inner_sub_partition_id; 
<a name="l00181"></a>00181     <span class="keywordtype">bool</span> sub_partition_contention = <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[spid]-&gt;<a class="code" href="classmemory__sub__partition.html#a7f1d2cc6ac11924c4a48465117b89e3e">dram_L2_queue_full</a>(); 
<a name="l00182"></a>00182     <span class="keywordtype">bool</span> has_dram_resource = <a class="code" href="classmemory__partition__unit.html#aa2a3a91b053c3c4d6f763ce639fe708c">m_arbitration_metadata</a>.<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a7d00c343c8445c53a00fec4ad8a8a89d">has_credits</a>(spid); 
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     MEMPART_DPRINTF(<span class="stringliteral">&quot;sub partition %d sub_partition_contention=%c has_dram_resource=%c\n&quot;</span>, 
<a name="l00185"></a>00185                     spid, (sub_partition_contention)? <span class="charliteral">&apos;T&apos;</span>:<span class="charliteral">&apos;F&apos;</span>, (has_dram_resource)? <span class="charliteral">&apos;T&apos;</span>:<span class="charliteral">&apos;F&apos;</span>); 
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keywordflow">return</span> (has_dram_resource &amp;&amp; !sub_partition_contention); 
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a><a class="code" href="classmemory__partition__unit.html#a63e9a35405f1272312ef9b8a83fc07b2">00190</a> <span class="keywordtype">int</span> <a class="code" href="classmemory__partition__unit.html#a63e9a35405f1272312ef9b8a83fc07b2">memory_partition_unit::global_sub_partition_id_to_local_id</a>(<span class="keywordtype">int</span> global_sub_partition_id)<span class="keyword"> const</span>
<a name="l00191"></a>00191 <span class="keyword"></span>{
<a name="l00192"></a>00192     <span class="keywordflow">return</span> (global_sub_partition_id - <a class="code" href="classmemory__partition__unit.html#a927053f13b600a75da9a56a996768b84">m_id</a> * <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>); 
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a><a class="code" href="classmemory__partition__unit.html#a5a089f454d78b521e56435b6af5ad484">00195</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a5a089f454d78b521e56435b6af5ad484">memory_partition_unit::dram_cycle</a>() 
<a name="l00196"></a>00196 { 
<a name="l00197"></a>00197     <span class="comment">// pop completed memory request from dram and push it to dram-to-L2 queue </span>
<a name="l00198"></a>00198     <span class="comment">// of the original sub partition </span>
<a name="l00199"></a>00199     <a class="code" href="classmem__fetch.html">mem_fetch</a>* mf_return = <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#ab3d768bb6fbcc2e29413c1f056e74ea5">return_queue_top</a>();
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (mf_return) {
<a name="l00201"></a>00201         <span class="keywordtype">unsigned</span> dest_global_spid = mf_return-&gt;<a class="code" href="classmem__fetch.html#a8c4e8b2934d81906b5dfbd1c826e6048">get_sub_partition_id</a>(); 
<a name="l00202"></a>00202         <span class="keywordtype">int</span> dest_spid = <a class="code" href="classmemory__partition__unit.html#a63e9a35405f1272312ef9b8a83fc07b2">global_sub_partition_id_to_local_id</a>(dest_global_spid); 
<a name="l00203"></a>00203         assert(<a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[dest_spid]-&gt;get_id() == dest_global_spid); 
<a name="l00204"></a>00204         <span class="keywordflow">if</span> (!<a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[dest_spid]-&gt;dram_L2_queue_full()) {
<a name="l00205"></a>00205             <span class="keywordflow">if</span>( mf_return-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L1_WRBK_ACC ) {
<a name="l00206"></a>00206                 <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[dest_spid]-&gt;<a class="code" href="classmemory__sub__partition.html#a4d2837ab2c9482ed9efaca54ad7c4b9e">set_done</a>(mf_return); 
<a name="l00207"></a>00207                 <span class="keyword">delete</span> mf_return;
<a name="l00208"></a>00208             } <span class="keywordflow">else</span> {
<a name="l00209"></a>00209                 <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[dest_spid]-&gt;<a class="code" href="classmemory__sub__partition.html#a78443ec50502328cbf53aeeb8a764129">dram_L2_queue_push</a>(mf_return);
<a name="l00210"></a>00210                 mf_return-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_DRAM_TO_L2_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00211"></a>00211                 <a class="code" href="classmemory__partition__unit.html#aa2a3a91b053c3c4d6f763ce639fe708c">m_arbitration_metadata</a>.<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ade9f55f83d3ff6fe6b44adc43920b7dd">return_credit</a>(dest_spid); 
<a name="l00212"></a>00212                 MEMPART_DPRINTF(<span class="stringliteral">&quot;mem_fetch request %p return from dram to sub partition %d\n&quot;</span>, mf_return, dest_spid); 
<a name="l00213"></a>00213             }
<a name="l00214"></a>00214             <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a9747fffbdae1c6f76fdea438c79ee50b">return_queue_pop</a>(); 
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216     } <span class="keywordflow">else</span> {
<a name="l00217"></a>00217         <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a9747fffbdae1c6f76fdea438c79ee50b">return_queue_pop</a>(); 
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219     
<a name="l00220"></a>00220     <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#ae0d873cc168b834f9629947bd20841fd">cycle</a>(); 
<a name="l00221"></a>00221     <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a3a4e980fd03d52f2cf93ff109f4c73a4">dram_log</a>(SAMPLELOG);   
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a2fa89bc1231c79fae392830c7aadbc61">full</a>() ) {
<a name="l00224"></a>00224         <span class="comment">// L2-&gt;DRAM queue to DRAM latency queue</span>
<a name="l00225"></a>00225         <span class="comment">// Arbitrate among multiple L2 subpartitions </span>
<a name="l00226"></a>00226         <span class="keywordtype">int</span> last_issued_partition = <a class="code" href="classmemory__partition__unit.html#aa2a3a91b053c3c4d6f763ce639fe708c">m_arbitration_metadata</a>.<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#a52112ed2aeea26b4de3c088141aa9641">last_borrower</a>(); 
<a name="l00227"></a>00227         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00228"></a>00228             <span class="keywordtype">int</span> spid = (p + last_issued_partition + 1) % <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; 
<a name="l00229"></a>00229             <a class="code" href="lex_8yy_8c.html#ad4a65b873df5c05570846b5413b41dfd">if</a> (!<a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[spid]-&gt;L2_dram_queue_empty() &amp;&amp; <a class="code" href="classmemory__partition__unit.html#a56f713a5a000a23a72e115dd7cb41104">can_issue_to_dram</a>(spid)) {
<a name="l00230"></a>00230                 <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[spid]-&gt;<a class="code" href="classmemory__sub__partition.html#a332c8f11cdac1193d47aa8cd413368c0">L2_dram_queue_top</a>();
<a name="l00231"></a>00231                 <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[spid]-&gt;<a class="code" href="classmemory__sub__partition.html#a8837382a5540d9416091743a018ac450">L2_dram_queue_pop</a>();
<a name="l00232"></a>00232                 MEMPART_DPRINTF(<span class="stringliteral">&quot;Issue mem_fetch request %p from sub partition %d to dram\n&quot;</span>, mf, spid); 
<a name="l00233"></a>00233                 <a class="code" href="structmemory__partition__unit_1_1dram__delay__t.html">dram_delay_t</a> d;
<a name="l00234"></a>00234                 d.<a class="code" href="structmemory__partition__unit_1_1dram__delay__t.html#a2a32477c6ac3850024bb6037be24eb16">req</a> = mf;
<a name="l00235"></a>00235                 d.<a class="code" href="structmemory__partition__unit_1_1dram__delay__t.html#a005a5076b0f9b59575ab060c9c5e7848">ready_cycle</a> = <a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a> + <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a368ef2bd8779b842ca641c4f68398764">dram_latency</a>;
<a name="l00236"></a>00236                 <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.push_back(d);
<a name="l00237"></a>00237                 mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_DRAM_LATENCY_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00238"></a>00238                 <a class="code" href="classmemory__partition__unit.html#aa2a3a91b053c3c4d6f763ce639fe708c">m_arbitration_metadata</a>.<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#adc4be6e2878e31f7ed415685c1f5e719">borrow_credit</a>(spid); 
<a name="l00239"></a>00239                 <span class="keywordflow">break</span>;  <span class="comment">// the DRAM should only accept one request per cycle </span>
<a name="l00240"></a>00240             }
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="comment">// DRAM latency queue</span>
<a name="l00245"></a>00245     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.empty() &amp;&amp; ( (<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>) &gt;= <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.front().ready_cycle ) &amp;&amp; !<a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a2fa89bc1231c79fae392830c7aadbc61">full</a>() ) {
<a name="l00246"></a>00246         <a class="code" href="classmem__fetch.html">mem_fetch</a>* mf = <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.front().req;
<a name="l00247"></a>00247         <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.pop_front();
<a name="l00248"></a>00248         <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a6378a7199225458f4bab20f32133ee41">push</a>(mf);
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a><a class="code" href="classmemory__partition__unit.html#a87922db6dc73514505231f8bae25abd0">00252</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a87922db6dc73514505231f8bae25abd0">memory_partition_unit::set_done</a>( <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf )
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254     <span class="keywordtype">unsigned</span> global_spid = mf-&gt;<a class="code" href="classmem__fetch.html#a8c4e8b2934d81906b5dfbd1c826e6048">get_sub_partition_id</a>(); 
<a name="l00255"></a>00255     <span class="keywordtype">int</span> spid = <a class="code" href="classmemory__partition__unit.html#a63e9a35405f1272312ef9b8a83fc07b2">global_sub_partition_id_to_local_id</a>(global_spid); 
<a name="l00256"></a>00256     assert(<a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[spid]-&gt;get_id() == global_spid); 
<a name="l00257"></a>00257     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L1_WRBK_ACC || mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L2_WRBK_ACC) {
<a name="l00258"></a>00258         <a class="code" href="classmemory__partition__unit.html#aa2a3a91b053c3c4d6f763ce639fe708c">m_arbitration_metadata</a>.<a class="code" href="classmemory__partition__unit_1_1arbitration__metadata.html#ade9f55f83d3ff6fe6b44adc43920b7dd">return_credit</a>(spid); 
<a name="l00259"></a>00259         MEMPART_DPRINTF(<span class="stringliteral">&quot;mem_fetch request %p return from dram to sub partition %d\n&quot;</span>, mf, spid); 
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261     <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[spid]-&gt;<a class="code" href="classmemory__sub__partition.html#a4d2837ab2c9482ed9efaca54ad7c4b9e">set_done</a>(mf); 
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a><a class="code" href="classmemory__partition__unit.html#a777672a7718f9be97f43d6d51f2f92cf">00264</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a777672a7718f9be97f43d6d51f2f92cf">memory_partition_unit::set_dram_power_stats</a>(<span class="keywordtype">unsigned</span> &amp;n_cmd,
<a name="l00265"></a>00265                                                  <span class="keywordtype">unsigned</span> &amp;n_activity,
<a name="l00266"></a>00266                                                  <span class="keywordtype">unsigned</span> &amp;n_nop,
<a name="l00267"></a>00267                                                  <span class="keywordtype">unsigned</span> &amp;n_act,
<a name="l00268"></a>00268                                                  <span class="keywordtype">unsigned</span> &amp;n_pre,
<a name="l00269"></a>00269                                                  <span class="keywordtype">unsigned</span> &amp;n_rd,
<a name="l00270"></a>00270                                                  <span class="keywordtype">unsigned</span> &amp;n_wr,
<a name="l00271"></a>00271                                                  <span class="keywordtype">unsigned</span> &amp;n_req)<span class="keyword"> const</span>
<a name="l00272"></a>00272 <span class="keyword"></span>{
<a name="l00273"></a>00273     <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#ab4076288026b452af1b422b7ff8b01ea">set_dram_power_stats</a>(n_cmd, n_activity, n_nop, n_act, n_pre, n_rd, n_wr, n_req);
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="classmemory__partition__unit.html#a3e9c697307e08cdc0da97a7dc777a211">00276</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__partition__unit.html#a3e9c697307e08cdc0da97a7dc777a211">memory_partition_unit::print</a>( FILE *fp )<span class="keyword"> const</span>
<a name="l00277"></a>00277 <span class="keyword"></span>{
<a name="l00278"></a>00278     fprintf(fp, <span class="stringliteral">&quot;Memory Partition %u: \n&quot;</span>, <a class="code" href="classmemory__partition__unit.html#a927053f13b600a75da9a56a996768b84">m_id</a>); 
<a name="l00279"></a>00279     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p &lt; <a class="code" href="classmemory__partition__unit.html#a33366fea9f947353222e4b0201ca8bbf">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a94d168569ced756bfd18c2d49235e3c0">m_n_sub_partition_per_memory_channel</a>; p++) {
<a name="l00280"></a>00280         <a class="code" href="classmemory__partition__unit.html#a5dfc730695d5f49f47a8d43f930b8f3a">m_sub_partition</a>[p]-&gt;<a class="code" href="classmemory__sub__partition.html#ae40943e69420549a96cdeeb4563e3c1f">print</a>(fp); 
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282     fprintf(fp, <span class="stringliteral">&quot;In Dram Latency Queue (total = %zd): \n&quot;</span>, <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.size()); 
<a name="l00283"></a>00283     <span class="keywordflow">for</span> (std::list&lt;dram_delay_t&gt;::const_iterator mf_dlq = <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.begin(); 
<a name="l00284"></a>00284          mf_dlq != <a class="code" href="classmemory__partition__unit.html#af41b40cbda99326d2fd43dcccb8b095e">m_dram_latency_queue</a>.end(); ++mf_dlq) {
<a name="l00285"></a>00285         <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = mf_dlq-&gt;req; 
<a name="l00286"></a>00286         fprintf(fp, <span class="stringliteral">&quot;Ready @ %llu - &quot;</span>, mf_dlq-&gt;ready_cycle); 
<a name="l00287"></a>00287         <span class="keywordflow">if</span> (mf) 
<a name="l00288"></a>00288             mf-&gt;<a class="code" href="classmem__fetch.html#a604c79db27d4ce4e6d83d76db53ce00e">print</a>(fp); 
<a name="l00289"></a>00289         <span class="keywordflow">else</span> 
<a name="l00290"></a>00290             fprintf(fp, <span class="stringliteral">&quot; &lt;NULL mem_fetch?&gt;\n&quot;</span>); 
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     <a class="code" href="classmemory__partition__unit.html#ae4e5293ed7580247ae7158bf2d746ef0">m_dram</a>-&gt;<a class="code" href="classdram__t.html#a6fe9727ef2494c389e95a8264d1a3891">print</a>(fp); 
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a><a class="code" href="classmemory__sub__partition.html#a1c73560ff733407323431a82c533fc52">00295</a> <a class="code" href="classmemory__sub__partition.html#a1c73560ff733407323431a82c533fc52">memory_sub_partition::memory_sub_partition</a>( <span class="keywordtype">unsigned</span> sub_partition_id, 
<a name="l00296"></a>00296                                             <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmemory__config.html">memory_config</a> *config,
<a name="l00297"></a>00297                                             <span class="keyword">class</span> <a class="code" href="classmemory__stats__t.html">memory_stats_t</a> *stats )
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <a class="code" href="classmemory__sub__partition.html#a622b491a811dd03d243b1670ddffd9b1">m_id</a> = sub_partition_id;
<a name="l00300"></a>00300     <a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>=config;
<a name="l00301"></a>00301     <a class="code" href="classmemory__sub__partition.html#ab6c5ae13e34173993434c75770bd1563">m_stats</a>=stats;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     assert(m_id &lt; m_config-&gt;m_n_mem_sub_partition); 
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordtype">char</span> L2c_name[32];
<a name="l00306"></a>00306     snprintf(L2c_name, 32, <span class="stringliteral">&quot;L2_bank_%03d&quot;</span>, <a class="code" href="classmemory__sub__partition.html#a622b491a811dd03d243b1670ddffd9b1">m_id</a>);
<a name="l00307"></a>00307     <a class="code" href="classmemory__sub__partition.html#a7c0ee810b6fb57c5eb633f1f8e1579fd">m_L2interface</a> = <span class="keyword">new</span> <a class="code" href="classmemory__sub__partition.html#a2f0d4a3efc7d0098cbf09bf10220d654">L2interface</a>(<span class="keyword">this</span>);
<a name="l00308"></a>00308     <a class="code" href="classmemory__sub__partition.html#ab1ad37bf93e22d528be8d21fb7e3185b">m_mf_allocator</a> = <span class="keyword">new</span> <a class="code" href="classpartition__mf__allocator.html">partition_mf_allocator</a>(config);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordflow">if</span>(!<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>())
<a name="l00311"></a>00311        <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a> = <span class="keyword">new</span> <a class="code" href="classl2__cache.html">l2_cache</a>(L2c_name,<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>,-1,-1,<a class="code" href="classmemory__sub__partition.html#a7c0ee810b6fb57c5eb633f1f8e1579fd">m_L2interface</a>,<a class="code" href="classmemory__sub__partition.html#ab1ad37bf93e22d528be8d21fb7e3185b">m_mf_allocator</a>,IN_PARTITION_L2_MISS_QUEUE);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> icnt_L2;
<a name="l00314"></a>00314     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> L2_dram;
<a name="l00315"></a>00315     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dram_L2;
<a name="l00316"></a>00316     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> L2_icnt;
<a name="l00317"></a>00317     sscanf(<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#ade7bd81e2d11f12a30d52b5c73b37c7a">gpgpu_L2_queue_config</a>,<span class="stringliteral">&quot;%u:%u:%u:%u&quot;</span>, &amp;icnt_L2,&amp;L2_dram,&amp;dram_L2,&amp;L2_icnt );
<a name="l00318"></a>00318     <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a> = <span class="keyword">new</span> <a class="code" href="classfifo__pipeline.html">fifo_pipeline&lt;mem_fetch&gt;</a>(<span class="stringliteral">&quot;icnt-to-L2&quot;</span>,0,icnt_L2); 
<a name="l00319"></a>00319     <a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a> = <span class="keyword">new</span> <a class="code" href="classfifo__pipeline.html">fifo_pipeline&lt;mem_fetch&gt;</a>(<span class="stringliteral">&quot;L2-to-dram&quot;</span>,0,L2_dram);
<a name="l00320"></a>00320     <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a> = <span class="keyword">new</span> <a class="code" href="classfifo__pipeline.html">fifo_pipeline&lt;mem_fetch&gt;</a>(<span class="stringliteral">&quot;dram-to-L2&quot;</span>,0,dram_L2);
<a name="l00321"></a>00321     <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a> = <span class="keyword">new</span> <a class="code" href="classfifo__pipeline.html">fifo_pipeline&lt;mem_fetch&gt;</a>(<span class="stringliteral">&quot;L2-to-icnt&quot;</span>,0,L2_icnt);
<a name="l00322"></a>00322     <a class="code" href="classmemory__sub__partition.html#ae5cf587338c92cca81086ef0f77a9578">wb_addr</a>=-1;
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="classmemory__sub__partition.html#aec77aa830f31f22fe9a6eeb4e47f9138">00325</a> <a class="code" href="classmemory__sub__partition.html#aec77aa830f31f22fe9a6eeb4e47f9138">memory_sub_partition::~memory_sub_partition</a>()
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <span class="keyword">delete</span> <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>;
<a name="l00328"></a>00328     <span class="keyword">delete</span> <a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a>;
<a name="l00329"></a>00329     <span class="keyword">delete</span> <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>;
<a name="l00330"></a>00330     <span class="keyword">delete</span> <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>;
<a name="l00331"></a>00331     <span class="keyword">delete</span> <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>;
<a name="l00332"></a>00332     <span class="keyword">delete</span> <a class="code" href="classmemory__sub__partition.html#a7c0ee810b6fb57c5eb633f1f8e1579fd">m_L2interface</a>;
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="classmemory__sub__partition.html#a00e9b1e998aea1895ff9898e5ac3ae83">00335</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a00e9b1e998aea1895ff9898e5ac3ae83">memory_sub_partition::cache_cycle</a>( <span class="keywordtype">unsigned</span> cycle )
<a name="l00336"></a>00336 {
<a name="l00337"></a>00337     <span class="comment">// L2 fill responses</span>
<a name="l00338"></a>00338     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>()) {
<a name="l00339"></a>00339        <span class="keywordflow">if</span> ( <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a35718e662874edff48a21967e79d5f4e" title="Are any (accepted) accesses that had to wait for memory now ready? (does not include...">access_ready</a>() &amp;&amp; !<a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>() ) {
<a name="l00340"></a>00340            <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a2130cc5c06e1642d3a5ab1ec77e54446" title="Pop next ready access (does not include accesses that &amp;quot;HIT&amp;quot;).">next_access</a>();
<a name="l00341"></a>00341            <span class="keywordflow">if</span>(mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() != L2_WR_ALLOC_R){ <span class="comment">// Don&apos;t pass write allocate read request back to upper level cache</span>
<a name="l00342"></a>00342                 mf-&gt;<a class="code" href="classmem__fetch.html#a5c0a6de6dafab89a3f4ab7349f1c9e8c">set_reply</a>();
<a name="l00343"></a>00343                 mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_L2_TO_ICNT_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00344"></a>00344                 <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(mf);
<a name="l00345"></a>00345            }<span class="keywordflow">else</span>{
<a name="l00346"></a>00346                 <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.erase(mf);
<a name="l00347"></a>00347                 <span class="keyword">delete</span> mf;
<a name="l00348"></a>00348            }
<a name="l00349"></a>00349        }
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="comment">// DRAM to L2 (texture) and icnt (not texture)</span>
<a name="l00353"></a>00353     <span class="keywordflow">if</span> ( !<a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a737f2b64684773b53329e52aee168c11">empty</a>() ) {
<a name="l00354"></a>00354         <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a7ef9a28fa0802ec9569a97ba240bd7f3">top</a>();
<a name="l00355"></a>00355         <span class="keywordflow">if</span> ( !<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>() &amp;&amp; <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a06bec784756cc377425fd5bfe94dff7e" title="Checks if mf is waiting to be filled by lower memory level.">waiting_for_fill</a>(mf) ) {
<a name="l00356"></a>00356             <span class="keywordflow">if</span> (<a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a88390b0ee869380c1d1aab31a7f1c93e">fill_port_free</a>()) {
<a name="l00357"></a>00357                 mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_L2_FILL_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00358"></a>00358                 <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#aa797b46275001da9451a5ce16f815569" title="Interface for response from lower memory level (model bandwidth restictions in caller)...">fill</a>(mf,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00359"></a>00359                 <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !<a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>() ) {
<a name="l00362"></a>00362             mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_L2_TO_ICNT_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00363"></a>00363             <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(mf);
<a name="l00364"></a>00364             <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     <span class="comment">// prior L2 misses inserted into m_L2_dram_queue here</span>
<a name="l00369"></a>00369     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>() )
<a name="l00370"></a>00370        <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a0622c3b477d40f97b694dd5d76de23cd" title="Sends next request to lower level of memory.">cycle</a>();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">// new L2 texture accesses and/or non-texture accesses</span>
<a name="l00373"></a>00373     <span class="keywordflow">if</span> ( !<a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>() &amp;&amp; !<a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a737f2b64684773b53329e52aee168c11">empty</a>() ) {
<a name="l00374"></a>00374         <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a7ef9a28fa0802ec9569a97ba240bd7f3">top</a>();
<a name="l00375"></a>00375         <span class="keywordflow">if</span> ( !<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>() &amp;&amp;
<a name="l00376"></a>00376               ( (<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a487f4c0c9c95f5c8d8657d22b7a372fb">m_L2_texure_only</a> &amp;&amp; mf-&gt;<a class="code" href="classmem__fetch.html#a361e4e41a80bff3acac726d8693a9fee">istexture</a>()) || (!<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a487f4c0c9c95f5c8d8657d22b7a372fb">m_L2_texure_only</a>) )
<a name="l00377"></a>00377            ) {
<a name="l00378"></a>00378             <span class="comment">// L2 is enabled and access is for L2</span>
<a name="l00379"></a>00379             <span class="keywordtype">bool</span> output_full = <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>(); 
<a name="l00380"></a>00380             <span class="keywordtype">bool</span> port_free = <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a249a368520b0f9349ff668a8a2e4feb3">data_port_free</a>(); 
<a name="l00381"></a>00381             <span class="keywordflow">if</span> ( !output_full &amp;&amp; port_free ) {
<a name="l00382"></a>00382                 std::list&lt;cache_event&gt; events;
<a name="l00383"></a>00383                 <span class="keyword">enum</span> <a class="code" href="gpu-cache_8h.html#a6ca15cb60df1ccf2f7d8e677d11a1bbe">cache_request_status</a> status = <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classl2__cache.html#a4ee1c008592f09a74a214994f9667142">access</a>(mf-&gt;<a class="code" href="classmem__fetch.html#a06fa448b09acf9a40fd294aa5877895b">get_addr</a>(),mf,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>,events);
<a name="l00384"></a>00384                 <span class="keywordtype">bool</span> write_sent = <a class="code" href="gpu-cache_8cc.html#aa34baf5c7076a8fee416099590acd38d">was_write_sent</a>(events);
<a name="l00385"></a>00385                 <span class="keywordtype">bool</span> read_sent = <a class="code" href="gpu-cache_8cc.html#af9debd40908ecef2127f815eba3864fe">was_read_sent</a>(events);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387                 <span class="keywordflow">if</span> ( status == <a class="code" href="gpu-cache_8h.html#a6ca15cb60df1ccf2f7d8e677d11a1bbead4cf8619fedf804702c72835be555da0">HIT</a> ) {
<a name="l00388"></a>00388                     <span class="keywordflow">if</span>( !write_sent ) {
<a name="l00389"></a>00389                         <span class="comment">// L2 cache replies</span>
<a name="l00390"></a>00390                         assert(!read_sent);
<a name="l00391"></a>00391                         <span class="keywordflow">if</span>( mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L1_WRBK_ACC ) {
<a name="l00392"></a>00392                             <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.erase(mf);
<a name="l00393"></a>00393                             <span class="keyword">delete</span> mf;
<a name="l00394"></a>00394                         } <span class="keywordflow">else</span> {
<a name="l00395"></a>00395                             mf-&gt;<a class="code" href="classmem__fetch.html#a5c0a6de6dafab89a3f4ab7349f1c9e8c">set_reply</a>();
<a name="l00396"></a>00396                             mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_L2_TO_ICNT_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+gpu_tot_sim_cycle);
<a name="l00397"></a>00397                             <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(mf);
<a name="l00398"></a>00398                         }
<a name="l00399"></a>00399                         <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00400"></a>00400                     } <span class="keywordflow">else</span> {
<a name="l00401"></a>00401                         assert(write_sent);
<a name="l00402"></a>00402                         <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00403"></a>00403                     }
<a name="l00404"></a>00404                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( status != <a class="code" href="gpu-cache_8h.html#a6ca15cb60df1ccf2f7d8e677d11a1bbead6cd0ba3ddc29343844c2c23345a2460">RESERVATION_FAIL</a> ) {
<a name="l00405"></a>00405                     <span class="comment">// L2 cache accepted request</span>
<a name="l00406"></a>00406                     <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00407"></a>00407                 } <span class="keywordflow">else</span> {
<a name="l00408"></a>00408                     assert(!write_sent);
<a name="l00409"></a>00409                     assert(!read_sent);
<a name="l00410"></a>00410                     <span class="comment">// L2 cache lock-up: will try again next cycle</span>
<a name="l00411"></a>00411                 }
<a name="l00412"></a>00412             }
<a name="l00413"></a>00413         } <span class="keywordflow">else</span> {
<a name="l00414"></a>00414             <span class="comment">// L2 is disabled or non-texture access to texture-only L2</span>
<a name="l00415"></a>00415             mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_L2_TO_DRAM_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00416"></a>00416             <a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(mf);
<a name="l00417"></a>00417             <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <span class="comment">// ROP delay queue</span>
<a name="l00422"></a>00422     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__sub__partition.html#adb5a2244799506cac4fe0a90f9fa51a1">m_rop</a>.empty() &amp;&amp; (cycle &gt;= <a class="code" href="classmemory__sub__partition.html#adb5a2244799506cac4fe0a90f9fa51a1">m_rop</a>.front().ready_cycle) &amp;&amp; !<a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>() ) {
<a name="l00423"></a>00423         <a class="code" href="classmem__fetch.html">mem_fetch</a>* mf = <a class="code" href="classmemory__sub__partition.html#adb5a2244799506cac4fe0a90f9fa51a1">m_rop</a>.front().req;
<a name="l00424"></a>00424         <a class="code" href="classmemory__sub__partition.html#adb5a2244799506cac4fe0a90f9fa51a1">m_rop</a>.pop();
<a name="l00425"></a>00425         <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(mf);
<a name="l00426"></a>00426         mf-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_ICNT_TO_L2_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a><a class="code" href="classmemory__sub__partition.html#a74c7e89bc7de9a39cfd859b47a2444ec">00430</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__sub__partition.html#a74c7e89bc7de9a39cfd859b47a2444ec">memory_sub_partition::full</a>()<span class="keyword"> const</span>
<a name="l00431"></a>00431 <span class="keyword"></span>{
<a name="l00432"></a>00432     <span class="keywordflow">return</span> <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>();
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a><a class="code" href="classmemory__sub__partition.html#a8721f5738b943abb66ea263fda53054d">00435</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__sub__partition.html#a8721f5738b943abb66ea263fda53054d">memory_sub_partition::L2_dram_queue_empty</a>()<span class="keyword"> const</span>
<a name="l00436"></a>00436 <span class="keyword"></span>{
<a name="l00437"></a>00437    <span class="keywordflow">return</span> <a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a737f2b64684773b53329e52aee168c11">empty</a>(); 
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="classmemory__sub__partition.html#a332c8f11cdac1193d47aa8cd413368c0">00440</a> <span class="keyword">class </span><a class="code" href="classmem__fetch.html">mem_fetch</a>* <a class="code" href="classmemory__sub__partition.html#a332c8f11cdac1193d47aa8cd413368c0">memory_sub_partition::L2_dram_queue_top</a>()<span class="keyword"> const</span>
<a name="l00441"></a>00441 <span class="keyword"></span>{
<a name="l00442"></a>00442    <span class="keywordflow">return</span> <a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a7ef9a28fa0802ec9569a97ba240bd7f3">top</a>(); 
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="classmemory__sub__partition.html#a8837382a5540d9416091743a018ac450">00445</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a8837382a5540d9416091743a018ac450">memory_sub_partition::L2_dram_queue_pop</a>() 
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447    <a class="code" href="classmemory__sub__partition.html#aa35274f68a2980db2fd36ae46103215a">m_L2_dram_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>(); 
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="classmemory__sub__partition.html#a7f1d2cc6ac11924c4a48465117b89e3e">00450</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__sub__partition.html#a7f1d2cc6ac11924c4a48465117b89e3e">memory_sub_partition::dram_L2_queue_full</a>()<span class="keyword"> const</span>
<a name="l00451"></a>00451 <span class="keyword"></span>{
<a name="l00452"></a>00452    <span class="keywordflow">return</span> <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#aac7a16c9350c4c9d4cd75dfb26c9e64c">full</a>(); 
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="classmemory__sub__partition.html#a78443ec50502328cbf53aeeb8a764129">00455</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a78443ec50502328cbf53aeeb8a764129">memory_sub_partition::dram_L2_queue_push</a>( <span class="keyword">class</span> <a class="code" href="classmem__fetch.html">mem_fetch</a>* mf )
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457    <a class="code" href="classmemory__sub__partition.html#ac0a383888244e08d5c13efb9b71c7a84">m_dram_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(mf); 
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00460"></a><a class="code" href="classmemory__sub__partition.html#a15b8cdd3bcc6ad1c225e42d60237143c">00460</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a15b8cdd3bcc6ad1c225e42d60237143c">memory_sub_partition::print_cache_stat</a>(<span class="keywordtype">unsigned</span> &amp;accesses, <span class="keywordtype">unsigned</span> &amp;misses)<span class="keyword"> const</span>
<a name="l00461"></a>00461 <span class="keyword"></span>{
<a name="l00462"></a>00462     FILE *fp = stdout;
<a name="l00463"></a>00463     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>() )
<a name="l00464"></a>00464        <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a742af2dacfc8bcb7d75f8aa647420b52">print</a>(fp,accesses,misses);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a><a class="code" href="classmemory__sub__partition.html#ae40943e69420549a96cdeeb4563e3c1f">00467</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#ae40943e69420549a96cdeeb4563e3c1f">memory_sub_partition::print</a>( FILE *fp )<span class="keyword"> const</span>
<a name="l00468"></a>00468 <span class="keyword"></span>{
<a name="l00469"></a>00469     <span class="keywordflow">if</span> ( !<a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.empty() ) {
<a name="l00470"></a>00470         fprintf(fp,<span class="stringliteral">&quot;Memory Sub Parition %u: pending memory requests:\n&quot;</span>, <a class="code" href="classmemory__sub__partition.html#a622b491a811dd03d243b1670ddffd9b1">m_id</a>);
<a name="l00471"></a>00471         <span class="keywordflow">for</span> ( std::set&lt;mem_fetch*&gt;::const_iterator r=<a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.begin(); r != <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.end(); ++r ) {
<a name="l00472"></a>00472             <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = *r;
<a name="l00473"></a>00473             <span class="keywordflow">if</span> ( mf )
<a name="l00474"></a>00474                 mf-&gt;<a class="code" href="classmem__fetch.html#a604c79db27d4ce4e6d83d76db53ce00e">print</a>(fp);
<a name="l00475"></a>00475             <span class="keywordflow">else</span>
<a name="l00476"></a>00476                 fprintf(fp,<span class="stringliteral">&quot; &lt;NULL mem_fetch?&gt;\n&quot;</span>);
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     <span class="keywordflow">if</span>( !<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>() )
<a name="l00480"></a>00480        <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a09f1f92f49e7976978fbd0acc20e1948">display_state</a>(fp);
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a><a class="code" href="classmemory__stats__t.html#a7a88a1198cded3346c50fe7d5acdb74c">00483</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__stats__t.html#a7a88a1198cded3346c50fe7d5acdb74c">memory_stats_t::visualizer_print</a>( gzFile visualizer_file )
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485    <span class="comment">// gzprintf(visualizer_file, &quot;Ltwowritemiss: %d\n&quot;, L2_write_miss);</span>
<a name="l00486"></a>00486    <span class="comment">// gzprintf(visualizer_file, &quot;Ltwowritehit: %d\n&quot;,  L2_write_access-L2_write_miss);</span>
<a name="l00487"></a>00487    <span class="comment">// gzprintf(visualizer_file, &quot;Ltworeadmiss: %d\n&quot;, L2_read_miss);</span>
<a name="l00488"></a>00488    <span class="comment">// gzprintf(visualizer_file, &quot;Ltworeadhit: %d\n&quot;, L2_read_access-L2_read_miss);</span>
<a name="l00489"></a>00489    <span class="keywordflow">if</span> (<a class="code" href="classmemory__stats__t.html#adf5df41225ad57254e4f3921b8ccf3cb">num_mfs</a>)
<a name="l00490"></a>00490       gzprintf(visualizer_file, <span class="stringliteral">&quot;averagemflatency: %lld\n&quot;</span>, <a class="code" href="classmemory__stats__t.html#a5c8f2227bb0e0e3223eaeedcdf94247f">mf_total_lat</a>/<a class="code" href="classmemory__stats__t.html#adf5df41225ad57254e4f3921b8ccf3cb">num_mfs</a>);
<a name="l00491"></a>00491 }
<a name="l00492"></a>00492 
<a name="l00493"></a><a class="code" href="classgpgpu__sim.html#a36f71979fb8ed9bb316048fa0c206f1f">00493</a> <span class="keywordtype">void</span> <a class="code" href="classgpgpu__sim.html#a36f71979fb8ed9bb316048fa0c206f1f">gpgpu_sim::print_dram_stats</a>(FILE *fout)<span class="keyword"> const</span>
<a name="l00494"></a>00494 <span class="keyword"></span>{
<a name="l00495"></a>00495     <span class="keywordtype">unsigned</span> cmd=0;
<a name="l00496"></a>00496     <span class="keywordtype">unsigned</span> <a class="code" href="arch__const_8h.html#a239d6875038959e0516bb05d3dd1e8fc">activity</a>=0;
<a name="l00497"></a>00497     <span class="keywordtype">unsigned</span> nop=0;
<a name="l00498"></a>00498     <span class="keywordtype">unsigned</span> act=0;
<a name="l00499"></a>00499     <span class="keywordtype">unsigned</span> pre=0;
<a name="l00500"></a>00500     <span class="keywordtype">unsigned</span> rd=0;
<a name="l00501"></a>00501     <span class="keywordtype">unsigned</span> wr=0;
<a name="l00502"></a>00502     <span class="keywordtype">unsigned</span> req=0;
<a name="l00503"></a>00503     <span class="keywordtype">unsigned</span> tot_cmd=0;
<a name="l00504"></a>00504     <span class="keywordtype">unsigned</span> tot_nop=0;
<a name="l00505"></a>00505     <span class="keywordtype">unsigned</span> tot_act=0;
<a name="l00506"></a>00506     <span class="keywordtype">unsigned</span> tot_pre=0;
<a name="l00507"></a>00507     <span class="keywordtype">unsigned</span> tot_rd=0;
<a name="l00508"></a>00508     <span class="keywordtype">unsigned</span> tot_wr=0;
<a name="l00509"></a>00509     <span class="keywordtype">unsigned</span> tot_req=0;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0;i&lt;<a class="code" href="classgpgpu__sim.html#a22b61a4a6a437f12bb54aff405bc37b1">m_memory_config</a>-&gt;<a class="code" href="structmemory__config.html#a23314d672956964a7da0b46a625bd02d">m_n_mem</a>;i++){
<a name="l00512"></a>00512         <a class="code" href="classgpgpu__sim.html#a626905ae726a238cc7d676d14dc1a1c7">m_memory_partition_unit</a>[i]-&gt;<a class="code" href="classmemory__partition__unit.html#a777672a7718f9be97f43d6d51f2f92cf">set_dram_power_stats</a>(cmd,activity,nop,act,pre,rd,wr,req);
<a name="l00513"></a>00513         tot_cmd+=cmd;
<a name="l00514"></a>00514         tot_nop+=nop;
<a name="l00515"></a>00515         tot_act+=act;
<a name="l00516"></a>00516         tot_pre+=pre;
<a name="l00517"></a>00517         tot_rd+=rd;
<a name="l00518"></a>00518         tot_wr+=wr;
<a name="l00519"></a>00519         tot_req+=req;
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_reads = %d\n&quot;</span>,tot_rd );
<a name="l00522"></a>00522     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_writes = %d\n&quot;</span>,tot_wr );
<a name="l00523"></a>00523     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_activate = %d\n&quot;</span>,tot_act );
<a name="l00524"></a>00524     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_commands = %d\n&quot;</span>,tot_cmd);
<a name="l00525"></a>00525     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_noops = %d\n&quot;</span>,tot_nop );
<a name="l00526"></a>00526     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_precharges = %d\n&quot;</span>,tot_pre );
<a name="l00527"></a>00527     fprintf(fout,<span class="stringliteral">&quot;gpgpu_n_dram_requests = %d\n&quot;</span>,tot_req );
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a><a class="code" href="classmemory__sub__partition.html#af761d115eb7b2dadd37c9113ff58e50b">00530</a> <span class="keywordtype">unsigned</span> <a class="code" href="classmemory__sub__partition.html#af761d115eb7b2dadd37c9113ff58e50b">memory_sub_partition::flushL2</a>() 
<a name="l00531"></a>00531 { 
<a name="l00532"></a>00532     <span class="keywordflow">if</span> (!<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>()) {
<a name="l00533"></a>00533         <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#a994069b98eb1be5326e618cafb04bb79">flush</a>(); 
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535     <span class="keywordflow">return</span> 0; <span class="comment">// L2 is read only in this version</span>
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="classmemory__sub__partition.html#a734ab70909266d1ca1e915216a405a31">00538</a> <span class="keywordtype">bool</span> <a class="code" href="classmemory__sub__partition.html#a734ab70909266d1ca1e915216a405a31">memory_sub_partition::busy</a>()<span class="keyword"> const </span>
<a name="l00539"></a>00539 <span class="keyword"></span>{
<a name="l00540"></a>00540     <span class="keywordflow">return</span> !<a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.empty();
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a><a class="code" href="classmemory__sub__partition.html#a7ba7c9c14d7a41328af9d0176c0cba39">00543</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a7ba7c9c14d7a41328af9d0176c0cba39">memory_sub_partition::push</a>( <a class="code" href="classmem__fetch.html">mem_fetch</a>* req, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> cycle ) 
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (req) {
<a name="l00546"></a>00546         <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.insert(req);
<a name="l00547"></a>00547         <a class="code" href="classmemory__sub__partition.html#ab6c5ae13e34173993434c75770bd1563">m_stats</a>-&gt;<a class="code" href="classmemory__stats__t.html#a38d8473e6ee24aef30f0889bf20d1d05">memlatstat_icnt2mem_pop</a>(req);
<a name="l00548"></a>00548         <span class="keywordflow">if</span>( req-&gt;<a class="code" href="classmem__fetch.html#a361e4e41a80bff3acac726d8693a9fee">istexture</a>() ) {
<a name="l00549"></a>00549             <a class="code" href="classmemory__sub__partition.html#a86feb0a9f8c221ae0f1150d744481103">m_icnt_L2_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a56c3c47193df39f15ebd5ff960d273d0">push</a>(req);
<a name="l00550"></a>00550             req-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_ICNT_TO_L2_QUEUE,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00551"></a>00551         } <span class="keywordflow">else</span> {
<a name="l00552"></a>00552             <a class="code" href="structmemory__sub__partition_1_1rop__delay__t.html">rop_delay_t</a> r;
<a name="l00553"></a>00553             r.<a class="code" href="structmemory__sub__partition_1_1rop__delay__t.html#a2dd8b3d2e74a01c4f05f4a9fab9f0b22">req</a> = req;
<a name="l00554"></a>00554             r.<a class="code" href="structmemory__sub__partition_1_1rop__delay__t.html#a321803fd8fe73ef1419677163b65de12">ready_cycle</a> = cycle + <a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a53fd23e3984e09767f74a95bbc24af35">rop_latency</a>;
<a name="l00555"></a>00555             <a class="code" href="classmemory__sub__partition.html#adb5a2244799506cac4fe0a90f9fa51a1">m_rop</a>.push(r);
<a name="l00556"></a>00556             req-&gt;<a class="code" href="classmem__fetch.html#acbda50764b3c8d6f79ffa279021253da">set_status</a>(IN_PARTITION_ROP_DELAY,<a class="code" href="gpu-sim_8cc.html#a659fec271553d05e676c52314c8fcfe1">gpu_sim_cycle</a>+<a class="code" href="gpu-sim_8cc.html#acef6bbfd6ec09fe29e2641cace785058">gpu_tot_sim_cycle</a>);
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="classmemory__sub__partition.html#ac8e55e7667127a2103453d9eab10fe71">00561</a> <a class="code" href="classmem__fetch.html">mem_fetch</a>* <a class="code" href="classmemory__sub__partition.html#ac8e55e7667127a2103453d9eab10fe71">memory_sub_partition::pop</a>() 
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563     <a class="code" href="classmem__fetch.html">mem_fetch</a>* mf = <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00564"></a>00564     <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.erase(mf);
<a name="l00565"></a>00565     <span class="keywordflow">if</span> ( mf &amp;&amp; mf-&gt;<a class="code" href="classmem__fetch.html#aa5bcee879d65fa5954c35a05a50e7f5e">isatomic</a>() )
<a name="l00566"></a>00566         mf-&gt;<a class="code" href="classmem__fetch.html#a6286f7360620fb53683b36309de433fb">do_atomic</a>();
<a name="l00567"></a>00567     <span class="keywordflow">if</span>( mf &amp;&amp; (mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L2_WRBK_ACC || mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L1_WRBK_ACC) ) {
<a name="l00568"></a>00568         <span class="keyword">delete</span> mf;
<a name="l00569"></a>00569         mf = NULL;
<a name="l00570"></a>00570     } 
<a name="l00571"></a>00571     <span class="keywordflow">return</span> mf;
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a><a class="code" href="classmemory__sub__partition.html#a096db6be7ab013446a907013366fc3a7">00574</a> <a class="code" href="classmem__fetch.html">mem_fetch</a>* <a class="code" href="classmemory__sub__partition.html#a096db6be7ab013446a907013366fc3a7">memory_sub_partition::top</a>() 
<a name="l00575"></a>00575 {
<a name="l00576"></a>00576     <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf = <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a7ef9a28fa0802ec9569a97ba240bd7f3">top</a>();
<a name="l00577"></a>00577     <span class="keywordflow">if</span>( mf &amp;&amp; (mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L2_WRBK_ACC || mf-&gt;<a class="code" href="classmem__fetch.html#ad6d11b27562271b7e6a99c76005021b1">get_access_type</a>() == L1_WRBK_ACC) ) {
<a name="l00578"></a>00578         <a class="code" href="classmemory__sub__partition.html#a01aa6d22669b286e67e63cb5141cd3f9">m_L2_icnt_queue</a>-&gt;<a class="code" href="classfifo__pipeline.html#a88ff57f90f79dc1e7280f8d4d469c949">pop</a>();
<a name="l00579"></a>00579         <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.erase(mf);
<a name="l00580"></a>00580         <span class="keyword">delete</span> mf;
<a name="l00581"></a>00581         mf = NULL;
<a name="l00582"></a>00582     } 
<a name="l00583"></a>00583     <span class="keywordflow">return</span> mf;
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a><a class="code" href="classmemory__sub__partition.html#a4d2837ab2c9482ed9efaca54ad7c4b9e">00586</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a4d2837ab2c9482ed9efaca54ad7c4b9e">memory_sub_partition::set_done</a>( <a class="code" href="classmem__fetch.html">mem_fetch</a> *mf )
<a name="l00587"></a>00587 {
<a name="l00588"></a>00588     <a class="code" href="classmemory__sub__partition.html#ae784aa6753c6ea008de04643ea574366">m_request_tracker</a>.erase(mf);
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="classmemory__sub__partition.html#a729bdd93c041d476a52f4c228e72c198">00591</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a729bdd93c041d476a52f4c228e72c198">memory_sub_partition::accumulate_L2cache_stats</a>(<span class="keyword">class</span> <a class="code" href="classcache__stats.html">cache_stats</a> &amp;l2_stats)<span class="keyword"> const </span>{
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (!<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>()) {
<a name="l00593"></a>00593         l2_stats += <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#af3d41b44d4bdea8c07eb66693d0dcc4e">get_stats</a>();
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="classmemory__sub__partition.html#a103ea9c8429690093c0ee3cf280bd816">00597</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a103ea9c8429690093c0ee3cf280bd816">memory_sub_partition::get_L2cache_sub_stats</a>(<span class="keyword">struct</span> <a class="code" href="structcache__sub__stats.html">cache_sub_stats</a> &amp;css)<span class="keyword"> const</span>{
<a name="l00598"></a>00598     <span class="keywordflow">if</span> (!<a class="code" href="classmemory__sub__partition.html#a383f750d779b2bb6d5cd6f948536f924">m_config</a>-&gt;<a class="code" href="structmemory__config.html#a7fa0daff849c196f6a52f0b5d21c320c">m_L2_config</a>.<a class="code" href="classcache__config.html#a6e719909c6b7bea759a1d98bc49236b3">disabled</a>()) {
<a name="l00599"></a>00599         <a class="code" href="classmemory__sub__partition.html#a7def1d771bbde1d621311ee0ddcbf950">m_L2cache</a>-&gt;<a class="code" href="classbaseline__cache.html#ab18435fe3071f7d77a41cc221e9a774d">get_sub_stats</a>(css);
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a><a class="code" href="classmemory__sub__partition.html#a015bc320ef6092ce1ec1c4dd28af6b34">00603</a> <span class="keywordtype">void</span> <a class="code" href="classmemory__sub__partition.html#a015bc320ef6092ce1ec1c4dd28af6b34">memory_sub_partition::visualizer_print</a>( gzFile visualizer_file )
<a name="l00604"></a>00604 {
<a name="l00605"></a>00605     <span class="comment">// TODO: Add visualizer stats for L2 cache </span>
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 13 May 2014 for GPGPU-Sim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
