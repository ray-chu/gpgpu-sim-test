<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GPGPU-Sim: v3.x/src/intersim2/networks/flatfly_onchip.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_c934b74ccb33d6b9bfd1e576787940d8.html">v3.x</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_da58ad9beee6988f697f1a76e412a52a.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_7e44b91c2d8bca2324eb4df0ed8bb374.html">intersim2</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_775dcafec0a961b10f24f646adb1c103.html">networks</a>
  </div>
</div>
<div class="contents">
<h1>flatfly_onchip.cpp</h1><a href="flatfly__onchip_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// $Id: flatfly_onchip.cpp 5188 2012-08-30 00:31:31Z dub $</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/*</span>
<a name="l00004"></a>00004 <span class="comment"> Copyright (c) 2007-2012, Trustees of The Leland Stanford Junior University</span>
<a name="l00005"></a>00005 <span class="comment"> All rights reserved.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment"> Redistribution and use in source and binary forms, with or without</span>
<a name="l00008"></a>00008 <span class="comment"> modification, are permitted provided that the following conditions are met:</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment"> Redistributions of source code must retain the above copyright notice, this </span>
<a name="l00011"></a>00011 <span class="comment"> list of conditions and the following disclaimer.</span>
<a name="l00012"></a>00012 <span class="comment"> Redistributions in binary form must reproduce the above copyright notice, this</span>
<a name="l00013"></a>00013 <span class="comment"> list of conditions and the following disclaimer in the documentation and/or</span>
<a name="l00014"></a>00014 <span class="comment"> other materials provided with the distribution.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment"> THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<a name="l00017"></a>00017 <span class="comment"> ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<a name="l00018"></a>00018 <span class="comment"> WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE </span>
<a name="l00019"></a>00019 <span class="comment"> DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR</span>
<a name="l00020"></a>00020 <span class="comment"> ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00021"></a>00021 <span class="comment"> (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00022"></a>00022 <span class="comment"> LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<a name="l00023"></a>00023 <span class="comment"> ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00024"></a>00024 <span class="comment"> (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<a name="l00025"></a>00025 <span class="comment"> SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00026"></a>00026 <span class="comment">*/</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">//Flattened butterfly simulator</span>
<a name="l00029"></a>00029 <span class="comment">//Created by John Kim</span>
<a name="l00030"></a>00030 <span class="comment">//</span>
<a name="l00031"></a>00031 <span class="comment">//Updated 11/6/2007 by Ted Jiang, now scales </span>
<a name="l00032"></a>00032 <span class="comment">//with any n such that N = K^3, k is a power of 2</span>
<a name="l00033"></a>00033 <span class="comment">//however, the change restrict it to a 2D FBfly</span>
<a name="l00034"></a>00034 <span class="comment">//</span>
<a name="l00035"></a>00035 <span class="comment">//updated sometimes in december by Ted Jiang, now works for updat to 4</span>
<a name="l00036"></a>00036 <span class="comment">//dimension. </span>
<a name="l00037"></a>00037 <span class="comment">//</span>
<a name="l00038"></a>00038 <span class="comment">//Updated 2/4/08 by Ted Jiang disabling partial networks</span>
<a name="l00039"></a>00039 <span class="comment">//change concentrations</span>
<a name="l00040"></a>00040 <span class="comment">//</span>
<a name="l00041"></a>00041 <span class="comment">//More update 3/31/08 to correctly assign the nodes to the routers</span>
<a name="l00042"></a>00042 <span class="comment">//UGAL now has added a &quot;mapping&quot; to account for this new assignment</span>
<a name="l00043"></a>00043 <span class="comment">//of the nodes to the routers</span>
<a name="l00044"></a>00044 <span class="comment">//</span>
<a name="l00045"></a>00045 <span class="comment">//Updated by mihelog   27 Aug to add progressive choice of intermediate destination.</span>
<a name="l00046"></a>00046 <span class="comment">//Also, half of the total vcs are used for non-minimal routing, others for minimal (for UGAL and valiant).</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;booksim.hpp&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="flatfly__onchip_8hpp.html">flatfly_onchip.hpp</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;random_utils.hpp&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;misc_utils.hpp&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="globals_8hpp.html">globals.hpp</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">//#define DEBUG_FLATFLY</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="flatfly__onchip_8cpp.html#a8f9db2b06a8d137223f68d56b2192d64">00063</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#a8f9db2b06a8d137223f68d56b2192d64">_xcount</a>;
<a name="l00064"></a><a class="code" href="flatfly__onchip_8cpp.html#ad48a60e36efd893f04cc00c25f04425e">00064</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#ad48a60e36efd893f04cc00c25f04425e">_ycount</a>;
<a name="l00065"></a><a class="code" href="flatfly__onchip_8cpp.html#a04239670f10619aa147f89e77041bbd0">00065</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#a04239670f10619aa147f89e77041bbd0">_xrouter</a>;
<a name="l00066"></a><a class="code" href="flatfly__onchip_8cpp.html#a6301ffe5908eb9b5530e19aef0dbec1e">00066</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#a6301ffe5908eb9b5530e19aef0dbec1e">_yrouter</a>;
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="classFlatFlyOnChip.html#a110154a356d7e1a679743c75368be0b1">00068</a> <a class="code" href="classFlatFlyOnChip.html#a110154a356d7e1a679743c75368be0b1">FlatFlyOnChip::FlatFlyOnChip</a>( <span class="keyword">const</span> <a class="code" href="classConfiguration.html">Configuration</a> &amp;config, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; name ) :
<a name="l00069"></a>00069   <a class="code" href="classNetwork.html">Network</a>( config, name )
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071 
<a name="l00072"></a>00072   <a class="code" href="classFlatFlyOnChip.html#afd5fcb7094c3f0fe36c25ffe3427be4e">_ComputeSize</a>( config );
<a name="l00073"></a>00073   <a class="code" href="classNetwork.html#ab384d48c72bae0e48f5efd3f7065399f">_Alloc</a>( );
<a name="l00074"></a>00074   <a class="code" href="classFlatFlyOnChip.html#ac96c4c81b37b19b65d4a1718a89eac84">_BuildNet</a>( config );
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="classFlatFlyOnChip.html#afd5fcb7094c3f0fe36c25ffe3427be4e">00077</a> <span class="keywordtype">void</span> <a class="code" href="classFlatFlyOnChip.html#afd5fcb7094c3f0fe36c25ffe3427be4e">FlatFlyOnChip::_ComputeSize</a>( <span class="keyword">const</span> <a class="code" href="classConfiguration.html">Configuration</a> &amp;config )
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079   <a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a> = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>( <span class="stringliteral">&quot;k&quot;</span> );    <span class="comment">// # of routers per dimension</span>
<a name="l00080"></a>00080   <a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a> = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>( <span class="stringliteral">&quot;n&quot;</span> );    <span class="comment">// dimension</span>
<a name="l00081"></a>00081   <a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a> = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>( <span class="stringliteral">&quot;c&quot;</span> );    <span class="comment">//concentration, may be different from k</span>
<a name="l00082"></a>00082   <a class="code" href="classFlatFlyOnChip.html#adb8b6a4a1bbaaa46f3eae6db28eb91a4">_r</a> = <a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a> + (<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>-1)*<a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a> ;     <span class="comment">// total radix of the switch  ( # of inputs/outputs)</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   <span class="comment">//how many routers in the x or y direction</span>
<a name="l00085"></a>00085   _xcount = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>(<span class="stringliteral">&quot;x&quot;</span>);
<a name="l00086"></a>00086   _ycount = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>(<span class="stringliteral">&quot;y&quot;</span>);
<a name="l00087"></a>00087   assert(_xcount == _ycount);
<a name="l00088"></a>00088   <span class="comment">//configuration of hohw many clients in X and Y per router</span>
<a name="l00089"></a>00089   _xrouter = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>(<span class="stringliteral">&quot;xr&quot;</span>);
<a name="l00090"></a>00090   _yrouter = config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>(<span class="stringliteral">&quot;yr&quot;</span>);
<a name="l00091"></a>00091   assert(_xrouter == _yrouter);
<a name="l00092"></a>00092   <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a> = <a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>; 
<a name="l00093"></a>00093   <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a> = <a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a>;
<a name="l00094"></a>00094   <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> = <a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a>;
<a name="l00095"></a>00095   
<a name="l00096"></a>00096   assert(<a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a> == _xrouter*_yrouter);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098   <a class="code" href="classNetwork.html#abe0e51c8228a2b087e7510d0bf58be62">_nodes</a> = <a class="code" href="misc__utils_8cpp.html#add89cd3058e518c99a645eff11531afa">powi</a>( <a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>, <a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a> )*<a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a>;   <span class="comment">//network size</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <a class="code" href="classFlatFlyOnChip.html#aed678a29d5d81f801dc4f5ed9dbfb2c7">_num_of_switch</a> = <a class="code" href="classNetwork.html#abe0e51c8228a2b087e7510d0bf58be62">_nodes</a> / <a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a>;
<a name="l00101"></a>00101   <a class="code" href="classNetwork.html#a22420a8913a2f0ca47ade9a21ca8b3aa">_channels</a> = <a class="code" href="classFlatFlyOnChip.html#aed678a29d5d81f801dc4f5ed9dbfb2c7">_num_of_switch</a> * (<a class="code" href="classFlatFlyOnChip.html#adb8b6a4a1bbaaa46f3eae6db28eb91a4">_r</a> - <a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a>); 
<a name="l00102"></a>00102   <a class="code" href="classNetwork.html#a56daf3677029ca295cfd5208978ffb35">_size</a> = <a class="code" href="classFlatFlyOnChip.html#aed678a29d5d81f801dc4f5ed9dbfb2c7">_num_of_switch</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="classFlatFlyOnChip.html#ac96c4c81b37b19b65d4a1718a89eac84">00106</a> <span class="keywordtype">void</span> <a class="code" href="classFlatFlyOnChip.html#ac96c4c81b37b19b65d4a1718a89eac84">FlatFlyOnChip::_BuildNet</a>( <span class="keyword">const</span> <a class="code" href="classConfiguration.html">Configuration</a> &amp;config )
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108   <span class="keywordtype">int</span> _output;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   ostringstream router_name;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   
<a name="l00113"></a>00113   <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     cout&lt;&lt;<span class="stringliteral">&quot;Setup Finished Router&quot;</span>&lt;&lt;endl;
<a name="l00116"></a>00116     
<a name="l00117"></a>00117   }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   <span class="comment">//latency type, noc or conventional network</span>
<a name="l00120"></a>00120   <span class="keywordtype">bool</span> use_noc_latency;
<a name="l00121"></a>00121   use_noc_latency = (config.<a class="code" href="classConfiguration.html#a924090a06ca73bc53ed73c5f4f2cae27">GetInt</a>(<span class="stringliteral">&quot;use_noc_latency&quot;</span>)==1);
<a name="l00122"></a>00122   
<a name="l00123"></a>00123   cout &lt;&lt; <span class="stringliteral">&quot; Flat Bufferfly &quot;</span> &lt;&lt; endl;
<a name="l00124"></a>00124   cout &lt;&lt; <span class="stringliteral">&quot; k = &quot;</span> &lt;&lt; <a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a> &lt;&lt; <span class="stringliteral">&quot; n = &quot;</span> &lt;&lt; <a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a> &lt;&lt; <span class="stringliteral">&quot; c = &quot;</span>&lt;&lt;<a class="code" href="classFlatFlyOnChip.html#a641b519ef94806ce7b1ebfc6a117e505">_c</a>&lt;&lt; endl;
<a name="l00125"></a>00125   cout &lt;&lt; <span class="stringliteral">&quot; each switch - total radix =  &quot;</span>&lt;&lt; <a class="code" href="classFlatFlyOnChip.html#adb8b6a4a1bbaaa46f3eae6db28eb91a4">_r</a> &lt;&lt; endl;
<a name="l00126"></a>00126   cout &lt;&lt; <span class="stringliteral">&quot; # of switches = &quot;</span>&lt;&lt;  <a class="code" href="classFlatFlyOnChip.html#aed678a29d5d81f801dc4f5ed9dbfb2c7">_num_of_switch</a> &lt;&lt; endl;
<a name="l00127"></a>00127   cout &lt;&lt; <span class="stringliteral">&quot; # of channels = &quot;</span>&lt;&lt;  <a class="code" href="classNetwork.html#a22420a8913a2f0ca47ade9a21ca8b3aa">_channels</a> &lt;&lt; endl;
<a name="l00128"></a>00128   cout &lt;&lt; <span class="stringliteral">&quot; # of nodes ( size of network ) = &quot;</span> &lt;&lt; <a class="code" href="classNetwork.html#abe0e51c8228a2b087e7510d0bf58be62">_nodes</a> &lt;&lt; endl;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> node = 0; node &lt; <a class="code" href="classFlatFlyOnChip.html#aed678a29d5d81f801dc4f5ed9dbfb2c7">_num_of_switch</a>; ++node ) {
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     router_name &lt;&lt; <span class="stringliteral">&quot;router&quot;</span>;
<a name="l00133"></a>00133     router_name &lt;&lt; <span class="stringliteral">&quot;_&quot;</span> &lt;&lt;  node ;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <a class="code" href="classNetwork.html#a0a8954720a663b1e3bf345b675c193a8">_routers</a>[node] = <a class="code" href="classRouter.html#ad9e86a33dc90c60d23bebae8b5314e10">Router::NewRouter</a>( config, <span class="keyword">this</span>, router_name.str( ), 
<a name="l00136"></a>00136                     node, <a class="code" href="classFlatFlyOnChip.html#adb8b6a4a1bbaaa46f3eae6db28eb91a4">_r</a>, _r );
<a name="l00137"></a>00137     <a class="code" href="classNetwork.html#ab4858ae56a0d081d1f44b488b909393b">_timed_modules</a>.push_back(<a class="code" href="classNetwork.html#a0a8954720a663b1e3bf345b675c193a8">_routers</a>[node]);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="preprocessor">#ifdef DEBUG_FLATFLY</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">&quot; ======== router node : &quot;</span> &lt;&lt; node &lt;&lt; <span class="stringliteral">&quot; ======== &quot;</span> &lt;&lt; <span class="stringliteral">&quot; router_&quot;</span> &lt;&lt; router_name.str() &lt;&lt; <span class="stringliteral">&quot; router node # : &quot;</span> &lt;&lt; node &lt;&lt; endl;
<a name="l00142"></a>00142 <span class="preprocessor">#endif</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>
<a name="l00144"></a>00144     router_name.str(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <span class="comment">//******************************************************************</span>
<a name="l00147"></a>00147     <span class="comment">// add inject/eject channels connected to the processor nodes</span>
<a name="l00148"></a>00148     <span class="comment">//******************************************************************</span>
<a name="l00149"></a>00149     
<a name="l00150"></a>00150     <span class="comment">//as accurately model the length of these channels as possible</span>
<a name="l00151"></a>00151     <span class="keywordtype">int</span> yleng = -_yrouter/2;
<a name="l00152"></a>00152     <span class="keywordtype">int</span> xleng = -_xrouter/2;
<a name="l00153"></a>00153     <span class="keywordtype">bool</span> yodd = _yrouter%2==1;
<a name="l00154"></a>00154     <span class="keywordtype">bool</span> xodd = _xrouter%2==1;
<a name="l00155"></a>00155     
<a name="l00156"></a>00156     <span class="keywordtype">int</span> y_index = node/(_xcount);
<a name="l00157"></a>00157     <span class="keywordtype">int</span> x_index = node%(_xcount);
<a name="l00158"></a>00158     <span class="comment">//estimating distance from client to router</span>
<a name="l00159"></a>00159     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; _yrouter ; y++) {
<a name="l00160"></a>00160       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; _xrouter ; x++) {
<a name="l00161"></a>00161     <span class="comment">//Zero is a naughty number</span>
<a name="l00162"></a>00162     <span class="keywordflow">if</span>(yleng == 0 &amp;&amp; !yodd){
<a name="l00163"></a>00163       yleng++;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165     <span class="keywordflow">if</span>(xleng == 0 &amp;&amp; !xodd){
<a name="l00166"></a>00166       xleng++;
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="keywordtype">int</span> ileng = 1;   <span class="comment">//at least 1 away</span>
<a name="l00169"></a>00169     <span class="comment">//measure distance in the y direction</span>
<a name="l00170"></a>00170     <span class="keywordflow">if</span>(abs(yleng)&gt;1){
<a name="l00171"></a>00171       ileng+=(abs(yleng)-1);
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <span class="comment">//measure distance in the x direction</span>
<a name="l00174"></a>00174     <span class="keywordflow">if</span>(abs(xleng)&gt;1){
<a name="l00175"></a>00175       ileng+=(abs(xleng)-1);
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     <span class="comment">//increment for the next client, add Y, if full, reset y add x</span>
<a name="l00178"></a>00178     yleng++;
<a name="l00179"></a>00179     <span class="keywordflow">if</span>(yleng&gt;_yrouter/2){
<a name="l00180"></a>00180       yleng= -_yrouter/2;
<a name="l00181"></a>00181       xleng++;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     <span class="comment">//adopted from the CMESH, the first node has 0,1,8,9 (as an example)</span>
<a name="l00184"></a>00184     <span class="keywordtype">int</span> link = (_xcount * _xrouter) * (_yrouter * y_index + y) + (_xrouter * x_index + x) ;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span>(use_noc_latency){
<a name="l00187"></a>00187       <a class="code" href="classNetwork.html#aaf7264c1c2799f5d124a6465a8b1d1a7">_inject</a>[link]-&gt;SetLatency(ileng);
<a name="l00188"></a>00188       <a class="code" href="classNetwork.html#a96784b21ef9427a7ad929360c76655af">_inject_cred</a>[link]-&gt;SetLatency(ileng);
<a name="l00189"></a>00189       <a class="code" href="classNetwork.html#a7989751e88c72dd50d3338c00e75b3a3">_eject</a>[link] -&gt;SetLatency(ileng);
<a name="l00190"></a>00190       <a class="code" href="classNetwork.html#a5c1cb580f89433cf57ffeb777e888554">_eject_cred</a>[link]-&gt;SetLatency(ileng);
<a name="l00191"></a>00191     } <span class="keywordflow">else</span> {
<a name="l00192"></a>00192       <a class="code" href="classNetwork.html#aaf7264c1c2799f5d124a6465a8b1d1a7">_inject</a>[link]-&gt;SetLatency(1);
<a name="l00193"></a>00193       <a class="code" href="classNetwork.html#a96784b21ef9427a7ad929360c76655af">_inject_cred</a>[link]-&gt;SetLatency(1);
<a name="l00194"></a>00194       <a class="code" href="classNetwork.html#a7989751e88c72dd50d3338c00e75b3a3">_eject</a>[link] -&gt;SetLatency(1);
<a name="l00195"></a>00195       <a class="code" href="classNetwork.html#a5c1cb580f89433cf57ffeb777e888554">_eject_cred</a>[link]-&gt;SetLatency(1);
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     <a class="code" href="classNetwork.html#a0a8954720a663b1e3bf345b675c193a8">_routers</a>[node]-&gt;<a class="code" href="classRouter.html#afb19e537b8a083551b96924264bb59bd">AddInputChannel</a>( <a class="code" href="classNetwork.html#aaf7264c1c2799f5d124a6465a8b1d1a7">_inject</a>[link], <a class="code" href="classNetwork.html#a96784b21ef9427a7ad929360c76655af">_inject_cred</a>[link] );
<a name="l00198"></a>00198     
<a name="l00199"></a>00199 <span class="preprocessor">#ifdef DEBUG_FLATFLY</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">&quot;  Adding injection channel &quot;</span> &lt;&lt; link &lt;&lt; endl;
<a name="l00201"></a>00201 <span class="preprocessor">#endif</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>    
<a name="l00203"></a>00203     <a class="code" href="classNetwork.html#a0a8954720a663b1e3bf345b675c193a8">_routers</a>[node]-&gt;<a class="code" href="classRouter.html#a8e1fcc5756fc6f9bf9a885f46f41232b">AddOutputChannel</a>( <a class="code" href="classNetwork.html#a7989751e88c72dd50d3338c00e75b3a3">_eject</a>[link], <a class="code" href="classNetwork.html#a5c1cb580f89433cf57ffeb777e888554">_eject_cred</a>[link] );
<a name="l00204"></a>00204 <span class="preprocessor">#ifdef DEBUG_FLATFLY</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">&quot;  Adding ejection channel &quot;</span> &lt;&lt; link &lt;&lt; endl;
<a name="l00206"></a>00206 <span class="preprocessor">#endif</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span>      }
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209   }
<a name="l00210"></a>00210   <span class="comment">//******************************************************************</span>
<a name="l00211"></a>00211   <span class="comment">// add output inter-router channels</span>
<a name="l00212"></a>00212   <span class="comment">//******************************************************************</span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="comment">//for every router, in every dimension</span>
<a name="l00215"></a>00215   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> node = 0; node &lt; _num_of_switch; ++node ) {
<a name="l00216"></a>00216     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> dim = 0; dim &lt; <a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a>; ++dim ) {
<a name="l00217"></a>00217 
<a name="l00218"></a>00218       <span class="comment">//locate itself in every dimension</span>
<a name="l00219"></a>00219       <span class="keywordtype">int</span> xcurr = node%<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>;
<a name="l00220"></a>00220       <span class="keywordtype">int</span> ycurr = (<a class="code" href="classint.html">int</a>)(node/<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>);
<a name="l00221"></a>00221       <span class="keywordtype">int</span> curr3 = node%(<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>*<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>);
<a name="l00222"></a>00222       <span class="keywordtype">int</span> curr4 = (<a class="code" href="classint.html">int</a>)(node/(<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>*<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>));
<a name="l00223"></a>00223       <span class="keywordtype">int</span> curr5 = (<a class="code" href="classint.html">int</a>)(node/(_k*_k*_k));<span class="comment">//mmm didn&apos;t mean to be racist</span>
<a name="l00224"></a>00224       <span class="keywordtype">int</span> curr6 = (node%(_k*_k*_k));<span class="comment">//mmm didn&apos;t mean to be racist</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226       <span class="comment">//for every other router in the dimension</span>
<a name="l00227"></a>00227       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> cnt = 0; cnt &lt; (_k ); ++cnt ) { 
<a name="l00228"></a>00228     <span class="keywordtype">int</span> other=0; <span class="comment">//the other router that we are trying to connect</span>
<a name="l00229"></a>00229     <span class="keywordtype">int</span> offset = 0; <span class="comment">//silly ness when node&lt; other or when node&gt;other</span>
<a name="l00230"></a>00230     <span class="comment">//if xdimension</span>
<a name="l00231"></a>00231     <span class="keywordflow">if</span>(dim == 0){
<a name="l00232"></a>00232       other = ycurr * _k +cnt;
<a name="l00233"></a>00233     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dim ==1){
<a name="l00234"></a>00234       other = cnt * _k + xcurr;
<a name="l00235"></a>00235       <span class="keywordflow">if</span>(_n==3){
<a name="l00236"></a>00236         other+= curr4*_k*_k;
<a name="l00237"></a>00237       } 
<a name="l00238"></a>00238       <span class="keywordflow">if</span>(_n==4){
<a name="l00239"></a>00239         curr4=((<a class="code" href="classint.html">int</a>)(node/(_k*_k)))%_k;
<a name="l00240"></a>00240         other+= curr4*_k*_k+curr5*_k*_k*_k;
<a name="l00241"></a>00241       }
<a name="l00242"></a>00242     }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (dim ==2){
<a name="l00243"></a>00243       other = cnt*_k*_k + curr3;
<a name="l00244"></a>00244       <span class="keywordflow">if</span>(_n==4){
<a name="l00245"></a>00245         other+= curr5*_k*_k*_k;
<a name="l00246"></a>00246       }
<a name="l00247"></a>00247     }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (dim ==3){
<a name="l00248"></a>00248       other = cnt*_k*_k*_k+curr6;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     assert(dim &lt; 4);
<a name="l00251"></a>00251     <span class="keywordflow">if</span>(other == node){
<a name="l00252"></a>00252 <span class="preprocessor">#ifdef DEBUG_FLATFLY</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>      cout &lt;&lt; <span class="stringliteral">&quot;ignore channel : &quot;</span> &lt;&lt; _output &lt;&lt; <span class="stringliteral">&quot; to node &quot;</span> &lt;&lt; node &lt;&lt;<span class="stringliteral">&quot; and &quot;</span>&lt;&lt;other&lt;&lt;endl;
<a name="l00254"></a>00254 <span class="preprocessor">#endif</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span>      <span class="keywordflow">continue</span>;
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     <span class="comment">//calculate channel length</span>
<a name="l00258"></a>00258     <span class="keywordtype">int</span> length = 0;
<a name="l00259"></a>00259     <span class="keywordtype">int</span> oned = abs((node%_xcount)-(other%_xcount));
<a name="l00260"></a>00260     <span class="keywordtype">int</span> twod = abs(node/_xcount-other/_xcount);
<a name="l00261"></a>00261     length = _xrouter*oned + _yrouter *twod;
<a name="l00262"></a>00262     <span class="comment">//oh the node&lt;other silly ness</span>
<a name="l00263"></a>00263     <span class="keywordflow">if</span>(node&lt;other){
<a name="l00264"></a>00264       offset = -1;
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <span class="comment">//node, dimension, router within dimension. Good luck understanding this</span>
<a name="l00267"></a>00267     _output = (_k-1) * _n  * node + (_k-1) * dim  + cnt+offset;
<a name="l00268"></a>00268     
<a name="l00269"></a>00269     
<a name="l00270"></a>00270 <span class="preprocessor">#ifdef DEBUG_FLATFLY</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">&quot;Adding channel : &quot;</span> &lt;&lt; _output &lt;&lt; <span class="stringliteral">&quot; to node &quot;</span> &lt;&lt; node &lt;&lt;<span class="stringliteral">&quot; and &quot;</span>&lt;&lt;other&lt;&lt;<span class="stringliteral">&quot; with length &quot;</span>&lt;&lt;length&lt;&lt;endl;
<a name="l00272"></a>00272 <span class="preprocessor">#endif</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(use_noc_latency){
<a name="l00274"></a>00274       <a class="code" href="classNetwork.html#a3f899622f7411eec1ac0ddd00e6ee819">_chan</a>[_output]-&gt;SetLatency(length);
<a name="l00275"></a>00275       <a class="code" href="classNetwork.html#aa56aa08c3897e0fa5c9d2f3be3fd5416">_chan_cred</a>[_output]-&gt;SetLatency(length);
<a name="l00276"></a>00276     } <span class="keywordflow">else</span> {
<a name="l00277"></a>00277       <a class="code" href="classNetwork.html#a3f899622f7411eec1ac0ddd00e6ee819">_chan</a>[_output]-&gt;SetLatency(1);
<a name="l00278"></a>00278       <a class="code" href="classNetwork.html#aa56aa08c3897e0fa5c9d2f3be3fd5416">_chan_cred</a>[_output]-&gt;SetLatency(1);
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <a class="code" href="classNetwork.html#a0a8954720a663b1e3bf345b675c193a8">_routers</a>[node]-&gt;<a class="code" href="classRouter.html#a8e1fcc5756fc6f9bf9a885f46f41232b">AddOutputChannel</a>( <a class="code" href="classNetwork.html#a3f899622f7411eec1ac0ddd00e6ee819">_chan</a>[_output], <a class="code" href="classNetwork.html#aa56aa08c3897e0fa5c9d2f3be3fd5416">_chan_cred</a>[_output] );
<a name="l00281"></a>00281     
<a name="l00282"></a>00282     <a class="code" href="classNetwork.html#a0a8954720a663b1e3bf345b675c193a8">_routers</a>[other]-&gt;<a class="code" href="classRouter.html#afb19e537b8a083551b96924264bb59bd">AddInputChannel</a>( <a class="code" href="classNetwork.html#a3f899622f7411eec1ac0ddd00e6ee819">_chan</a>[_output], <a class="code" href="classNetwork.html#aa56aa08c3897e0fa5c9d2f3be3fd5416">_chan_cred</a>[_output]);
<a name="l00283"></a>00283     
<a name="l00284"></a>00284     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00285"></a>00285       cout&lt;&lt;<span class="stringliteral">&quot;Link &quot;</span>&lt;&lt;_output&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;node&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;other&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;length&lt;&lt;endl;
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287     
<a name="l00288"></a>00288       }
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290   }
<a name="l00291"></a>00291   <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00292"></a>00292     cout&lt;&lt;<span class="stringliteral">&quot;Setup Finished Link&quot;</span>&lt;&lt;endl;
<a name="l00293"></a>00293   }
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 
<a name="l00297"></a><a class="code" href="classFlatFlyOnChip.html#a91527fceb2d1a6d502a91d3b794a22f3">00297</a> <span class="keywordtype">int</span> <a class="code" href="classFlatFlyOnChip.html#a91527fceb2d1a6d502a91d3b794a22f3">FlatFlyOnChip::GetN</a>( )<span class="keyword"> const</span>
<a name="l00298"></a>00298 <span class="keyword"></span>{
<a name="l00299"></a>00299   <span class="keywordflow">return</span> <a class="code" href="classFlatFlyOnChip.html#aaf0ff46c2f18fc29346fe90f9e466ca4">_n</a>;
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a><a class="code" href="classFlatFlyOnChip.html#ab020fb27c0fbbcc400708911efd0a1e0">00302</a> <span class="keywordtype">int</span> <a class="code" href="classFlatFlyOnChip.html#ab020fb27c0fbbcc400708911efd0a1e0">FlatFlyOnChip::GetK</a>( )<span class="keyword"> const</span>
<a name="l00303"></a>00303 <span class="keyword"></span>{
<a name="l00304"></a>00304   <span class="keywordflow">return</span> <a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a>;
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a><a class="code" href="classFlatFlyOnChip.html#a23e19e495b795ef50decb11eca38d0bc">00307</a> <span class="keywordtype">void</span> <a class="code" href="classFlatFlyOnChip.html#a23e19e495b795ef50decb11eca38d0bc">FlatFlyOnChip::InsertRandomFaults</a>( <span class="keyword">const</span> <a class="code" href="classConfiguration.html">Configuration</a> &amp;config )
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a><a class="code" href="classFlatFlyOnChip.html#a7a4381006efd0c8bacc10473a144c9b7">00312</a> <span class="keywordtype">double</span> <a class="code" href="classFlatFlyOnChip.html#a7a4381006efd0c8bacc10473a144c9b7">FlatFlyOnChip::Capacity</a>( )<span class="keyword"> const</span>
<a name="l00313"></a>00313 <span class="keyword"></span>{
<a name="l00314"></a>00314   <span class="keywordflow">return</span> (<span class="keywordtype">double</span>)<a class="code" href="classFlatFlyOnChip.html#a168448301d9fb2002dc6b7531791a030">_k</a> / 8.0;
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 
<a name="l00318"></a><a class="code" href="classFlatFlyOnChip.html#a9bd6fccf7f6b6612cc8724a4c960faf9">00318</a> <span class="keywordtype">void</span> <a class="code" href="classFlatFlyOnChip.html#a9bd6fccf7f6b6612cc8724a4c960faf9">FlatFlyOnChip::RegisterRoutingFunctions</a>(){
<a name="l00319"></a>00319 
<a name="l00320"></a>00320   
<a name="l00321"></a>00321   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;ran_min_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#a853bf5481cfb841ca4adc1cbf68aea8e">min_flatfly</a>;
<a name="l00322"></a>00322   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;adaptive_xyyx_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#a5d52effe98576ce7747571aa73fb8eb7">adaptive_xyyx_flatfly</a>;
<a name="l00323"></a>00323   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;xyyx_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#a2cbb6870bd505195685571cc3bc953b8">xyyx_flatfly</a>;
<a name="l00324"></a>00324   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;valiant_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#a4ee76c42ddaf2462021f1dbe4fdbe15f">valiant_flatfly</a>;
<a name="l00325"></a>00325   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;ugal_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#aac4a02e2e51e44f90890f2a78afd03d4">ugal_flatfly_onchip</a>;
<a name="l00326"></a>00326   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;ugal_pni_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#ab48e4cf1c461a89f4a752169768fcb40">ugal_pni_flatfly_onchip</a>;
<a name="l00327"></a>00327   <a class="code" href="routefunc_8cpp.html#a0f29c5e50d61f6c53291c64c6e56ace4">gRoutingFunctionMap</a>[<span class="stringliteral">&quot;ugal_xyyx_flatfly&quot;</span>] = &amp;<a class="code" href="flatfly__onchip_8cpp.html#ad7aba27051755d95dbb3331565d42489">ugal_xyyx_flatfly_onchip</a>;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="comment">//The initial XY or YX minimal routing direction is chosen adaptively</span>
<a name="l00332"></a><a class="code" href="flatfly__onchip_8hpp.html#a5d52effe98576ce7747571aa73fb8eb7">00332</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#a5d52effe98576ce7747571aa73fb8eb7">adaptive_xyyx_flatfly</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel, 
<a name="l00333"></a>00333           <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l00334"></a>00334 { 
<a name="l00335"></a>00335   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l00336"></a>00336   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l00337"></a>00337   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l00338"></a>00338     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l00339"></a>00339     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l00340"></a>00340   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l00341"></a>00341     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l00342"></a>00342     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l00343"></a>00343   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l00344"></a>00344     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l00345"></a>00345     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l00346"></a>00346   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l00347"></a>00347     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l00348"></a>00348     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   <span class="keywordtype">int</span> out_port;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354   <span class="keywordflow">if</span>(inject) {
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     out_port = -1;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   } <span class="keywordflow">else</span> {
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordtype">int</span> dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00361"></a>00361     <span class="keywordtype">int</span> targetr = (<a class="code" href="classint.html">int</a>)(dest/<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="keywordflow">if</span>(targetr==r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>()){ <span class="comment">//if we are at the final router, yay, output to client</span>
<a name="l00364"></a>00364       out_port = dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     } <span class="keywordflow">else</span> {
<a name="l00367"></a>00367    
<a name="l00368"></a>00368       <span class="comment">//each class must have at least 2 vcs assigned or else xy_yx will deadlock</span>
<a name="l00369"></a>00369       <span class="keywordtype">int</span> <span class="keyword">const</span> available_vcs = (vcEnd - vcBegin + 1) / 2;
<a name="l00370"></a>00370       assert(available_vcs &gt; 0);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372       <span class="keywordtype">int</span> out_port_xy =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00373"></a>00373       <span class="keywordtype">int</span> out_port_yx =  <a class="code" href="flatfly__onchip_8cpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">flatfly_outport_yx</a>(dest, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00374"></a>00374 
<a name="l00375"></a>00375       <span class="comment">// Route order (XY or YX) determined when packet is injected</span>
<a name="l00376"></a>00376       <span class="comment">//  into the network, adaptively</span>
<a name="l00377"></a>00377       <span class="keywordtype">bool</span> x_then_y;
<a name="l00378"></a>00378       <span class="keywordflow">if</span>(in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>){
<a name="l00379"></a>00379     <span class="keywordtype">int</span> credit_xy = r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(out_port_xy);
<a name="l00380"></a>00380     <span class="keywordtype">int</span> credit_yx = r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(out_port_yx);
<a name="l00381"></a>00381     <span class="keywordflow">if</span>(credit_xy &gt; credit_yx) {
<a name="l00382"></a>00382       x_then_y = <span class="keyword">false</span>;
<a name="l00383"></a>00383     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(credit_xy &lt; credit_yx) {
<a name="l00384"></a>00384       x_then_y = <span class="keyword">true</span>;
<a name="l00385"></a>00385     } <span class="keywordflow">else</span> {
<a name="l00386"></a>00386       x_then_y = (<a class="code" href="random__utils_8cpp.html#ac46ec4a8515ceccca7c472ee3687b83f">RandomInt</a>(1) &gt; 0);
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388       } <span class="keywordflow">else</span> {
<a name="l00389"></a>00389     x_then_y =  (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; (vcBegin + available_vcs));
<a name="l00390"></a>00390       }
<a name="l00391"></a>00391       
<a name="l00392"></a>00392       <span class="keywordflow">if</span>(x_then_y) {
<a name="l00393"></a>00393     out_port = out_port_xy;
<a name="l00394"></a>00394     vcEnd -= available_vcs;
<a name="l00395"></a>00395       } <span class="keywordflow">else</span> {
<a name="l00396"></a>00396     out_port = out_port_yx;
<a name="l00397"></a>00397     vcBegin += available_vcs;
<a name="l00398"></a>00398       }
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l00404"></a>00404 
<a name="l00405"></a>00405   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="comment">//The initial XY or YX minimal routing direction is chosen randomly</span>
<a name="l00409"></a><a class="code" href="flatfly__onchip_8hpp.html#a2cbb6870bd505195685571cc3bc953b8">00409</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#a2cbb6870bd505195685571cc3bc953b8">xyyx_flatfly</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel, 
<a name="l00410"></a>00410           <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l00411"></a>00411 { 
<a name="l00412"></a>00412   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l00413"></a>00413   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l00414"></a>00414   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l00415"></a>00415     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l00416"></a>00416     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l00417"></a>00417   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l00418"></a>00418     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l00419"></a>00419     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l00420"></a>00420   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l00421"></a>00421     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l00422"></a>00422     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l00423"></a>00423   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l00424"></a>00424     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l00425"></a>00425     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l00426"></a>00426   }
<a name="l00427"></a>00427   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l00428"></a>00428 
<a name="l00429"></a>00429   <span class="keywordtype">int</span> out_port;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="keywordflow">if</span>(inject) {
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     out_port = -1;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435   } <span class="keywordflow">else</span> {
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="keywordtype">int</span> dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00438"></a>00438     <span class="keywordtype">int</span> targetr = (<a class="code" href="classint.html">int</a>)(dest/<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="keywordflow">if</span>(targetr==r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>()){ <span class="comment">//if we are at the final router, yay, output to client</span>
<a name="l00441"></a>00441       out_port = dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     } <span class="keywordflow">else</span> {
<a name="l00444"></a>00444    
<a name="l00445"></a>00445       <span class="comment">//each class must have at least 2 vcs assigned or else xy_yx will deadlock</span>
<a name="l00446"></a>00446       <span class="keywordtype">int</span> <span class="keyword">const</span> available_vcs = (vcEnd - vcBegin + 1) / 2;
<a name="l00447"></a>00447       assert(available_vcs &gt; 0);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449       <span class="comment">// randomly select dimension order at first hop</span>
<a name="l00450"></a>00450       <span class="keywordtype">bool</span> x_then_y = ((in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) ?
<a name="l00451"></a>00451                (<a class="code" href="random__utils_8cpp.html#ac46ec4a8515ceccca7c472ee3687b83f">RandomInt</a>(1) &gt; 0) : 
<a name="l00452"></a>00452                (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; (vcBegin + available_vcs)));
<a name="l00453"></a>00453 
<a name="l00454"></a>00454       <span class="keywordflow">if</span>(x_then_y) {
<a name="l00455"></a>00455     out_port = <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00456"></a>00456     vcEnd -= available_vcs;
<a name="l00457"></a>00457       } <span class="keywordflow">else</span> {
<a name="l00458"></a>00458     out_port = <a class="code" href="flatfly__onchip_8cpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">flatfly_outport_yx</a>(dest, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00459"></a>00459     vcBegin += available_vcs;
<a name="l00460"></a>00460       }
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l00466"></a>00466 
<a name="l00467"></a>00467   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="flatfly__onchip_8hpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">00470</a> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">flatfly_outport_yx</a>(<span class="keywordtype">int</span> dest, <span class="keywordtype">int</span> rID) {
<a name="l00471"></a>00471   <span class="keywordtype">int</span> dest_rID = (<a class="code" href="classint.html">int</a>) (dest / <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l00472"></a>00472   <span class="keywordtype">int</span> _dim   = <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>;
<a name="l00473"></a>00473   <span class="keywordtype">int</span> <a class="code" href="cuobjdump__to__ptxplus_8cc.html#a850af8cfb632548b213ce5b365fedd1a">output</a> = -1, dID, sID;
<a name="l00474"></a>00474   
<a name="l00475"></a>00475   <span class="keywordflow">if</span>(dest_rID==rID){
<a name="l00476"></a>00476     <span class="keywordflow">return</span> dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00477"></a>00477   }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d=_dim-1;d &gt;= 0; d--) {
<a name="l00480"></a>00480     <span class="keywordtype">int</span> power = <a class="code" href="misc__utils_8cpp.html#add89cd3058e518c99a645eff11531afa">powi</a>(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>,d);
<a name="l00481"></a>00481     dID = <a class="code" href="classint.html">int</a>(dest_rID / power);
<a name="l00482"></a>00482     sID = <a class="code" href="classint.html">int</a>(rID / power);
<a name="l00483"></a>00483     <span class="keywordflow">if</span> ( dID != sID ) {
<a name="l00484"></a>00484       output = <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> + ((<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1)*d) - 1;
<a name="l00485"></a>00485       <span class="keywordflow">if</span> (dID &gt; sID) {
<a name="l00486"></a>00486     output += dID;
<a name="l00487"></a>00487       } <span class="keywordflow">else</span> {
<a name="l00488"></a>00488     output += dID + 1;
<a name="l00489"></a>00489       }
<a name="l00490"></a>00490       <span class="keywordflow">return</span> output;
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492     dest_rID = (<a class="code" href="classint.html">int</a>) (dest_rID %power);
<a name="l00493"></a>00493     rID      = (<a class="code" href="classint.html">int</a>) (rID %power);
<a name="l00494"></a>00494   }
<a name="l00495"></a>00495   <span class="keywordflow">if</span> (output == -1) {
<a name="l00496"></a>00496     cout &lt;&lt; <span class="stringliteral">&quot; ERROR ---- FLATFLY_OUTPORT function : output not found yx&quot;</span> &lt;&lt; endl;
<a name="l00497"></a>00497     exit(-1);
<a name="l00498"></a>00498   }
<a name="l00499"></a>00499   <span class="keywordflow">return</span> -1;
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a><a class="code" href="flatfly__onchip_8hpp.html#a4ee76c42ddaf2462021f1dbe4fdbe15f">00502</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#a4ee76c42ddaf2462021f1dbe4fdbe15f">valiant_flatfly</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel, 
<a name="l00503"></a>00503           <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l00506"></a>00506   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l00507"></a>00507   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l00508"></a>00508     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l00509"></a>00509     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l00510"></a>00510   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l00511"></a>00511     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l00512"></a>00512     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l00513"></a>00513   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l00514"></a>00514     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l00515"></a>00515     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l00516"></a>00516   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l00517"></a>00517     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l00518"></a>00518     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l00519"></a>00519   }
<a name="l00520"></a>00520   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   <span class="keywordtype">int</span> out_port;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524   <span class="keywordflow">if</span>(inject) {
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     out_port = -1;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   } <span class="keywordflow">else</span> {
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">if</span> ( in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> ){
<a name="l00531"></a>00531       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 0;
<a name="l00532"></a>00532       f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> = <a class="code" href="random__utils_8cpp.html#ac46ec4a8515ceccca7c472ee3687b83f">RandomInt</a>( <a class="code" href="misc__utils_8cpp.html#add89cd3058e518c99a645eff11531afa">powi</a>( <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>, <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a> )*<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>-1);
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="keywordtype">int</span> intm = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>);
<a name="l00536"></a>00536     <span class="keywordtype">int</span> dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)(intm/<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) == r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>() || (<a class="code" href="classint.html">int</a>)(dest/<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>)== r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>()){
<a name="l00539"></a>00539       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 1;
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">if</span>(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 0) {
<a name="l00543"></a>00543       out_port = <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(intm, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00544"></a>00544     } <span class="keywordflow">else</span> {
<a name="l00545"></a>00545       assert(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1);
<a name="l00546"></a>00546       out_port = <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)(dest/<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) != r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>()) {
<a name="l00550"></a>00550 
<a name="l00551"></a>00551       <span class="comment">//each class must have at least 2 vcs assigned or else valiant valiant will deadlock</span>
<a name="l00552"></a>00552       <span class="keywordtype">int</span> <span class="keyword">const</span> available_vcs = (vcEnd - vcBegin + 1) / 2;
<a name="l00553"></a>00553       assert(available_vcs &gt; 0);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555       <span class="keywordflow">if</span>(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 0) {
<a name="l00556"></a>00556     vcEnd -= available_vcs;
<a name="l00557"></a>00557       } <span class="keywordflow">else</span> {
<a name="l00558"></a>00558     <span class="comment">// If routing to final destination use the second half of the VCs.</span>
<a name="l00559"></a>00559     assert(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1);
<a name="l00560"></a>00560     vcBegin += available_vcs;
<a name="l00561"></a>00561       }
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564   }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l00567"></a>00567 
<a name="l00568"></a>00568   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a><a class="code" href="flatfly__onchip_8hpp.html#a853bf5481cfb841ca4adc1cbf68aea8e">00571</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#a853bf5481cfb841ca4adc1cbf68aea8e">min_flatfly</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel, 
<a name="l00572"></a>00572           <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l00575"></a>00575   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l00576"></a>00576   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l00577"></a>00577     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l00578"></a>00578     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l00579"></a>00579   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l00580"></a>00580     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l00581"></a>00581     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l00582"></a>00582   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l00583"></a>00583     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l00584"></a>00584     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l00585"></a>00585   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l00586"></a>00586     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l00587"></a>00587     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l00588"></a>00588   }
<a name="l00589"></a>00589   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l00590"></a>00590 
<a name="l00591"></a>00591   <span class="keywordtype">int</span> out_port;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593   <span class="keywordflow">if</span>(inject) {
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     out_port = -1;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597   } <span class="keywordflow">else</span> {
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordtype">int</span> dest  = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00600"></a>00600     <span class="keywordtype">int</span> targetr= (<a class="code" href="classint.html">int</a>)(dest/<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l00601"></a>00601     <span class="comment">//int xdest = ((int)(dest/gC)) % gK;</span>
<a name="l00602"></a>00602     <span class="comment">//int xcurr = ((r-&gt;GetID())) % gK;</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="comment">//int ydest = ((int)(dest/gC)) / gK;</span>
<a name="l00605"></a>00605     <span class="comment">//int ycurr = ((r-&gt;GetID())) / gK;</span>
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">if</span>(targetr==r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>()){ <span class="comment">//if we are at the final router, yay, output to client</span>
<a name="l00608"></a>00608       out_port = dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00609"></a>00609     } <span class="keywordflow">else</span>{ <span class="comment">//else select a dimension at random</span>
<a name="l00610"></a>00610       out_port = <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>());
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613   }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l00616"></a>00616 
<a name="l00617"></a>00617   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="comment">//=============================================================^M</span>
<a name="l00621"></a>00621 <span class="comment">// route UGAL in the flattened butterfly</span>
<a name="l00622"></a>00622 <span class="comment">//=============================================================^M</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 <span class="comment">//same as ugal except uses xyyx routing</span>
<a name="l00626"></a><a class="code" href="flatfly__onchip_8hpp.html#ad7aba27051755d95dbb3331565d42489">00626</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#ad7aba27051755d95dbb3331565d42489">ugal_xyyx_flatfly_onchip</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel,
<a name="l00627"></a>00627               <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l00630"></a>00630   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l00631"></a>00631   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l00632"></a>00632     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l00633"></a>00633     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l00634"></a>00634   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l00635"></a>00635     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l00636"></a>00636     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l00637"></a>00637   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l00638"></a>00638     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l00639"></a>00639     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l00640"></a>00640   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l00641"></a>00641     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l00642"></a>00642     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l00643"></a>00643   }
<a name="l00644"></a>00644   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l00645"></a>00645 
<a name="l00646"></a>00646   <span class="keywordtype">int</span> out_port;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   <span class="keywordflow">if</span>(inject) {
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     out_port = -1;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   } <span class="keywordflow">else</span> {
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <span class="keywordtype">int</span> dest  = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="keywordtype">int</span> rID =  r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>();
<a name="l00657"></a>00657     <span class="keywordtype">int</span> _concentration = <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00658"></a>00658     <span class="keywordtype">int</span> found;
<a name="l00659"></a>00659     <span class="keywordtype">int</span> debug = 0;
<a name="l00660"></a>00660     <span class="keywordtype">int</span> tmp_out_port, _ran_intm;
<a name="l00661"></a>00661     <span class="keywordtype">int</span> _min_hop, _nonmin_hop, _min_queucnt, _nonmin_queucnt;
<a name="l00662"></a>00662     <span class="keywordtype">int</span> threshold = 2;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordflow">if</span> ( in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> ){
<a name="l00666"></a>00666       <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00667"></a>00667     cout&lt;&lt;<span class="stringliteral">&quot;New Flit &quot;</span>&lt;&lt;f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>&lt;&lt;endl;
<a name="l00668"></a>00668       }
<a name="l00669"></a>00669       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a>   = 0;
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00673"></a>00673       <span class="keywordtype">int</span> load = 0;
<a name="l00674"></a>00674       cout&lt;&lt;<span class="stringliteral">&quot;Router &quot;</span>&lt;&lt;rID&lt;&lt;endl;
<a name="l00675"></a>00675       cout&lt;&lt;<span class="stringliteral">&quot;Input Channel &quot;</span>&lt;&lt;in_channel&lt;&lt;endl;
<a name="l00676"></a>00676       <span class="comment">//need to modify router to report the buffere depth</span>
<a name="l00677"></a>00677       load +=r-&gt;<a class="code" href="classRouter.html#a6c8ced6034de23b954643d8b18b3e52c">GetBufferOccupancy</a>(in_channel);
<a name="l00678"></a>00678       cout&lt;&lt;<span class="stringliteral">&quot;Rload &quot;</span>&lt;&lt;load&lt;&lt;endl;
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (debug){
<a name="l00682"></a>00682       cout &lt;&lt; <span class="stringliteral">&quot; FLIT ID: &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#aeae7d176eaa77ba7300abee6afbee8a4">id</a> &lt;&lt; <span class="stringliteral">&quot; Router: &quot;</span> &lt;&lt; rID &lt;&lt; <span class="stringliteral">&quot; routing from src : &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a> &lt;&lt;  <span class="stringliteral">&quot; to dest : &quot;</span> &lt;&lt; dest &lt;&lt; <span class="stringliteral">&quot; f-&gt;ph: &quot;</span> &lt;&lt;f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> &lt;&lt; <span class="stringliteral">&quot; intm: &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> &lt;&lt;  endl;
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <span class="comment">// f-&gt;ph == 0  ==&gt; make initial global adaptive decision</span>
<a name="l00685"></a>00685     <span class="comment">// f-&gt;ph == 1  ==&gt; route nonminimaly to random intermediate node</span>
<a name="l00686"></a>00686     <span class="comment">// f-&gt;ph == 2  ==&gt; route minimally to destination</span>
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     found = 0;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1){
<a name="l00691"></a>00691       dest = f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>;
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (dest &gt;= rID*_concentration &amp;&amp; dest &lt; (rID+1)*_concentration) {
<a name="l00695"></a>00695       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1) {
<a name="l00696"></a>00696     f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l00697"></a>00697     dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00698"></a>00698     <span class="keywordflow">if</span> (debug)   cout &lt;&lt; <span class="stringliteral">&quot;      done routing to intermediate &quot;</span>;
<a name="l00699"></a>00699       }
<a name="l00700"></a>00700       <span class="keywordflow">else</span>  {
<a name="l00701"></a>00701     found = 1;
<a name="l00702"></a>00702     out_port = dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00703"></a>00703     <span class="keywordflow">if</span> (debug)   cout &lt;&lt; <span class="stringliteral">&quot;      final routing to destination &quot;</span>;
<a name="l00704"></a>00704       }
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (!found) {
<a name="l00708"></a>00708 
<a name="l00709"></a>00709       <span class="keywordtype">int</span> <span class="keyword">const</span> xy_available_vcs = (vcEnd - vcBegin + 1) / 2;
<a name="l00710"></a>00710       assert(xy_available_vcs &gt; 0);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712       <span class="comment">// randomly select dimension order at first hop</span>
<a name="l00713"></a>00713       <span class="keywordtype">bool</span> x_then_y = ((in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) ?
<a name="l00714"></a>00714                (<a class="code" href="random__utils_8cpp.html#ac46ec4a8515ceccca7c472ee3687b83f">RandomInt</a>(1) &gt; 0) : 
<a name="l00715"></a>00715                (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; (vcBegin + xy_available_vcs)));
<a name="l00716"></a>00716 
<a name="l00717"></a>00717       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 0) {
<a name="l00718"></a>00718     <span class="comment">//find the min port and min distance</span>
<a name="l00719"></a>00719     _min_hop = <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>),dest);
<a name="l00720"></a>00720     <span class="keywordflow">if</span>(x_then_y){
<a name="l00721"></a>00721       tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, rID);
<a name="l00722"></a>00722     } <span class="keywordflow">else</span> {
<a name="l00723"></a>00723       tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">flatfly_outport_yx</a>(dest, rID);
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#aa5328bdf6d139ea1c8e503228bf8aae5">watch</a>){
<a name="l00726"></a>00726       cout &lt;&lt; <span class="stringliteral">&quot; MIN tmp_out_port: &quot;</span> &lt;&lt; tmp_out_port;
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728     <span class="comment">//sum over all vcs of that port</span>
<a name="l00729"></a>00729     _min_queucnt =   r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(tmp_out_port);
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="comment">//find the nonmin router, nonmin port, nonmin count</span>
<a name="l00732"></a>00732     _ran_intm = <a class="code" href="flatfly__onchip_8cpp.html#acad64c555069654f1f3152d66e92a6bf">find_ran_intm</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>), dest);
<a name="l00733"></a>00733     _nonmin_hop = <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>),_ran_intm) +    <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(_ran_intm, dest);
<a name="l00734"></a>00734     <span class="keywordflow">if</span>(x_then_y){
<a name="l00735"></a>00735       tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(_ran_intm, rID);
<a name="l00736"></a>00736     } <span class="keywordflow">else</span> {
<a name="l00737"></a>00737       tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">flatfly_outport_yx</a>(_ran_intm, rID);
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#aa5328bdf6d139ea1c8e503228bf8aae5">watch</a>){
<a name="l00741"></a>00741       cout &lt;&lt; <span class="stringliteral">&quot; NONMIN tmp_out_port: &quot;</span> &lt;&lt; tmp_out_port &lt;&lt; endl;
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     <span class="keywordflow">if</span> (_ran_intm &gt;= rID*_concentration &amp;&amp; _ran_intm &lt; (rID+1)*_concentration) {
<a name="l00744"></a>00744       _nonmin_queucnt = numeric_limits&lt;int&gt;::max();
<a name="l00745"></a>00745     } <span class="keywordflow">else</span>  {
<a name="l00746"></a>00746       _nonmin_queucnt =   r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(tmp_out_port);
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (debug){
<a name="l00750"></a>00750       cout &lt;&lt; <span class="stringliteral">&quot; _min_hop &quot;</span> &lt;&lt; _min_hop &lt;&lt; <span class="stringliteral">&quot; _min_queucnt: &quot;</span> &lt;&lt;_min_queucnt &lt;&lt; <span class="stringliteral">&quot; _nonmin_hop: &quot;</span> &lt;&lt; _nonmin_hop &lt;&lt; <span class="stringliteral">&quot; _nonmin_queucnt :&quot;</span> &lt;&lt; _nonmin_queucnt &lt;&lt;  endl;
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="keywordflow">if</span> (_min_hop * _min_queucnt   &lt;= _nonmin_hop * _nonmin_queucnt +threshold) {
<a name="l00754"></a>00754 
<a name="l00755"></a>00755       <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot; Route MINIMALLY &quot;</span> &lt;&lt; endl;
<a name="l00756"></a>00756       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l00757"></a>00757     } <span class="keywordflow">else</span> {
<a name="l00758"></a>00758       <span class="comment">// route non-minimally</span>
<a name="l00759"></a>00759       <span class="keywordflow">if</span> (debug)  { cout &lt;&lt; <span class="stringliteral">&quot; Route NONMINIMALLY int node: &quot;</span> &lt;&lt;_ran_intm &lt;&lt; endl; }
<a name="l00760"></a>00760       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 1;
<a name="l00761"></a>00761       f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> = _ran_intm;
<a name="l00762"></a>00762       dest = f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>;
<a name="l00763"></a>00763       <span class="keywordflow">if</span> (dest &gt;= rID*_concentration &amp;&amp; dest &lt; (rID+1)*_concentration) {
<a name="l00764"></a>00764         f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l00765"></a>00765         dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00766"></a>00766       }
<a name="l00767"></a>00767     }
<a name="l00768"></a>00768       }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770       <span class="comment">//dest here should be == intm if ph==1, or dest == dest if ph == 2</span>
<a name="l00771"></a>00771       <span class="keywordflow">if</span>(x_then_y){
<a name="l00772"></a>00772     out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, rID);
<a name="l00773"></a>00773     <span class="keywordflow">if</span>(out_port &gt;= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) {
<a name="l00774"></a>00774       vcEnd -= xy_available_vcs;
<a name="l00775"></a>00775     }
<a name="l00776"></a>00776       } <span class="keywordflow">else</span> {
<a name="l00777"></a>00777     out_port =  <a class="code" href="flatfly__onchip_8cpp.html#a2f8ed02ef6f09e6339c5023dd4da1eca">flatfly_outport_yx</a>(dest, rID);
<a name="l00778"></a>00778     <span class="keywordflow">if</span>(out_port &gt;= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) {
<a name="l00779"></a>00779       vcBegin += xy_available_vcs;
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781       }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783       <span class="comment">// if we haven&apos;t reached our destination, restrict VCs appropriately to avoid routing deadlock</span>
<a name="l00784"></a>00784       <span class="keywordflow">if</span>(out_port &gt;= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) {
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     <span class="keywordtype">int</span> <span class="keyword">const</span> ph_available_vcs = xy_available_vcs / 2;
<a name="l00787"></a>00787     assert(ph_available_vcs &gt; 0);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="keywordflow">if</span>(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1) {
<a name="l00790"></a>00790       vcEnd -= ph_available_vcs;
<a name="l00791"></a>00791     } <span class="keywordflow">else</span> {
<a name="l00792"></a>00792       assert(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 2);
<a name="l00793"></a>00793       vcBegin += ph_available_vcs;
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795       }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797       found = 1;
<a name="l00798"></a>00798     }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <span class="keywordflow">if</span> (!found) {
<a name="l00801"></a>00801       cout &lt;&lt; <span class="stringliteral">&quot; ERROR: output not found in routing. &quot;</span> &lt;&lt; endl;
<a name="l00802"></a>00802       cout &lt;&lt; *f; exit (-1);
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="keywordflow">if</span> (out_port &gt;= <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>*(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1) + <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>)  {
<a name="l00806"></a>00806       cout &lt;&lt; <span class="stringliteral">&quot; ERROR: output port too big! &quot;</span> &lt;&lt; endl;
<a name="l00807"></a>00807       cout &lt;&lt; <span class="stringliteral">&quot; OUTPUT select: &quot;</span> &lt;&lt; out_port &lt;&lt; endl;
<a name="l00808"></a>00808       cout &lt;&lt; <span class="stringliteral">&quot; router radix: &quot;</span> &lt;&lt;  <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>*(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1) + <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a> &lt;&lt; endl;
<a name="l00809"></a>00809       exit (-1);
<a name="l00810"></a>00810     }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot;        through output port : &quot;</span> &lt;&lt; out_port &lt;&lt; endl;
<a name="l00813"></a>00813     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){cout&lt;&lt;<span class="stringliteral">&quot;Outport &quot;</span>&lt;&lt;out_port&lt;&lt;endl;cout&lt;&lt;<span class="stringliteral">&quot;Stop Mark&quot;</span>&lt;&lt;endl;}
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="comment">//ugal now uses modified comparison, modefied getcredit</span>
<a name="l00825"></a><a class="code" href="flatfly__onchip_8hpp.html#aac4a02e2e51e44f90890f2a78afd03d4">00825</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#aac4a02e2e51e44f90890f2a78afd03d4">ugal_flatfly_onchip</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel,
<a name="l00826"></a>00826               <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l00829"></a>00829   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l00830"></a>00830   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l00831"></a>00831     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l00832"></a>00832     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l00833"></a>00833   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l00834"></a>00834     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l00835"></a>00835     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l00836"></a>00836   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l00837"></a>00837     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l00838"></a>00838     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l00839"></a>00839   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l00840"></a>00840     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l00841"></a>00841     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l00842"></a>00842   }
<a name="l00843"></a>00843   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l00844"></a>00844 
<a name="l00845"></a>00845   <span class="keywordtype">int</span> out_port;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847   <span class="keywordflow">if</span>(inject) {
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     out_port = -1;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851   } <span class="keywordflow">else</span> {
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <span class="keywordtype">int</span> dest  = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="keywordtype">int</span> rID =  r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>();
<a name="l00856"></a>00856     <span class="keywordtype">int</span> _concentration = <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00857"></a>00857     <span class="keywordtype">int</span> found;
<a name="l00858"></a>00858     <span class="keywordtype">int</span> debug = 0;
<a name="l00859"></a>00859     <span class="keywordtype">int</span> tmp_out_port, _ran_intm;
<a name="l00860"></a>00860     <span class="keywordtype">int</span> _min_hop, _nonmin_hop, _min_queucnt, _nonmin_queucnt;
<a name="l00861"></a>00861     <span class="keywordtype">int</span> threshold = 2;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     <span class="keywordflow">if</span> ( in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> ){
<a name="l00864"></a>00864       <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00865"></a>00865     cout&lt;&lt;<span class="stringliteral">&quot;New Flit &quot;</span>&lt;&lt;f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>&lt;&lt;endl;
<a name="l00866"></a>00866       }
<a name="l00867"></a>00867       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a>   = 0;
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l00871"></a>00871       <span class="keywordtype">int</span> load = 0;
<a name="l00872"></a>00872       cout&lt;&lt;<span class="stringliteral">&quot;Router &quot;</span>&lt;&lt;rID&lt;&lt;endl;
<a name="l00873"></a>00873       cout&lt;&lt;<span class="stringliteral">&quot;Input Channel &quot;</span>&lt;&lt;in_channel&lt;&lt;endl;
<a name="l00874"></a>00874       <span class="comment">//need to modify router to report the buffere depth</span>
<a name="l00875"></a>00875       load +=r-&gt;<a class="code" href="classRouter.html#a6c8ced6034de23b954643d8b18b3e52c">GetBufferOccupancy</a>(in_channel);
<a name="l00876"></a>00876       cout&lt;&lt;<span class="stringliteral">&quot;Rload &quot;</span>&lt;&lt;load&lt;&lt;endl;
<a name="l00877"></a>00877     }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="keywordflow">if</span> (debug){
<a name="l00880"></a>00880       cout &lt;&lt; <span class="stringliteral">&quot; FLIT ID: &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#aeae7d176eaa77ba7300abee6afbee8a4">id</a> &lt;&lt; <span class="stringliteral">&quot; Router: &quot;</span> &lt;&lt; rID &lt;&lt; <span class="stringliteral">&quot; routing from src : &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a> &lt;&lt;  <span class="stringliteral">&quot; to dest : &quot;</span> &lt;&lt; dest &lt;&lt; <span class="stringliteral">&quot; f-&gt;ph: &quot;</span> &lt;&lt;f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> &lt;&lt; <span class="stringliteral">&quot; intm: &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> &lt;&lt;  endl;
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882     <span class="comment">// f-&gt;ph == 0  ==&gt; make initial global adaptive decision</span>
<a name="l00883"></a>00883     <span class="comment">// f-&gt;ph == 1  ==&gt; route nonminimaly to random intermediate node</span>
<a name="l00884"></a>00884     <span class="comment">// f-&gt;ph == 2  ==&gt; route minimally to destination</span>
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     found = 0;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1){
<a name="l00889"></a>00889       dest = f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>;
<a name="l00890"></a>00890     }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <span class="keywordflow">if</span> (dest &gt;= rID*_concentration &amp;&amp; dest &lt; (rID+1)*_concentration) {
<a name="l00894"></a>00894 
<a name="l00895"></a>00895       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1) {
<a name="l00896"></a>00896     f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l00897"></a>00897     dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (debug)   cout &lt;&lt; <span class="stringliteral">&quot;      done routing to intermediate &quot;</span>;
<a name="l00899"></a>00899       }
<a name="l00900"></a>00900       <span class="keywordflow">else</span>  {
<a name="l00901"></a>00901     found = 1;
<a name="l00902"></a>00902     out_port = dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l00903"></a>00903     <span class="keywordflow">if</span> (debug)   cout &lt;&lt; <span class="stringliteral">&quot;      final routing to destination &quot;</span>;
<a name="l00904"></a>00904       }
<a name="l00905"></a>00905     }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907     <span class="keywordflow">if</span> (!found) {
<a name="l00908"></a>00908 
<a name="l00909"></a>00909       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 0) {
<a name="l00910"></a>00910     _min_hop = <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>),dest);
<a name="l00911"></a>00911     _ran_intm = <a class="code" href="flatfly__onchip_8cpp.html#acad64c555069654f1f3152d66e92a6bf">find_ran_intm</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>), dest);
<a name="l00912"></a>00912     tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, rID);
<a name="l00913"></a>00913     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#aa5328bdf6d139ea1c8e503228bf8aae5">watch</a>){
<a name="l00914"></a>00914       *<a class="code" href="globals_8hpp.html#a54233075d19c60edbe29257351f7fe3d">gWatchOut</a> &lt;&lt; <a class="code" href="globals_8hpp.html#ad223077827fd15227dc1bd007980a296">GetSimTime</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span> &lt;&lt; r-&gt;<a class="code" href="classModule.html#a0eeaa2b9a7d2ba88ab05682444898b08">FullName</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span>
<a name="l00915"></a>00915              &lt;&lt; <span class="stringliteral">&quot; MIN tmp_out_port: &quot;</span> &lt;&lt; tmp_out_port;
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     _min_queucnt =   r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(tmp_out_port);
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     _nonmin_hop = <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>),_ran_intm) +    <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(_ran_intm, dest);
<a name="l00921"></a>00921     tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(_ran_intm, rID);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#aa5328bdf6d139ea1c8e503228bf8aae5">watch</a>){
<a name="l00924"></a>00924       *<a class="code" href="globals_8hpp.html#a54233075d19c60edbe29257351f7fe3d">gWatchOut</a> &lt;&lt; <a class="code" href="globals_8hpp.html#ad223077827fd15227dc1bd007980a296">GetSimTime</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span> &lt;&lt; r-&gt;<a class="code" href="classModule.html#a0eeaa2b9a7d2ba88ab05682444898b08">FullName</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span>
<a name="l00925"></a>00925              &lt;&lt; <span class="stringliteral">&quot; NONMIN tmp_out_port: &quot;</span> &lt;&lt; tmp_out_port &lt;&lt; endl;
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927     <span class="keywordflow">if</span> (_ran_intm &gt;= rID*_concentration &amp;&amp; _ran_intm &lt; (rID+1)*_concentration) {
<a name="l00928"></a>00928       _nonmin_queucnt = numeric_limits&lt;int&gt;::max();
<a name="l00929"></a>00929     } <span class="keywordflow">else</span>  {
<a name="l00930"></a>00930       _nonmin_queucnt =   r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(tmp_out_port);
<a name="l00931"></a>00931     }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (debug){
<a name="l00934"></a>00934       cout &lt;&lt; <span class="stringliteral">&quot; _min_hop &quot;</span> &lt;&lt; _min_hop &lt;&lt; <span class="stringliteral">&quot; _min_queucnt: &quot;</span> &lt;&lt;_min_queucnt &lt;&lt; <span class="stringliteral">&quot; _nonmin_hop: &quot;</span> &lt;&lt; _nonmin_hop &lt;&lt; <span class="stringliteral">&quot; _nonmin_queucnt :&quot;</span> &lt;&lt; _nonmin_queucnt &lt;&lt;  endl;
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="keywordflow">if</span> (_min_hop * _min_queucnt   &lt;= _nonmin_hop * _nonmin_queucnt +threshold) {
<a name="l00938"></a>00938 
<a name="l00939"></a>00939       <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot; Route MINIMALLY &quot;</span> &lt;&lt; endl;
<a name="l00940"></a>00940       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l00941"></a>00941     } <span class="keywordflow">else</span> {
<a name="l00942"></a>00942       <span class="comment">// route non-minimally</span>
<a name="l00943"></a>00943       <span class="keywordflow">if</span> (debug)  { cout &lt;&lt; <span class="stringliteral">&quot; Route NONMINIMALLY int node: &quot;</span> &lt;&lt;_ran_intm &lt;&lt; endl; }
<a name="l00944"></a>00944       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 1;
<a name="l00945"></a>00945       f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> = _ran_intm;
<a name="l00946"></a>00946       dest = f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>;
<a name="l00947"></a>00947       <span class="keywordflow">if</span> (dest &gt;= rID*_concentration &amp;&amp; dest &lt; (rID+1)*_concentration) {
<a name="l00948"></a>00948         f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l00949"></a>00949         dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l00950"></a>00950       }
<a name="l00951"></a>00951     }
<a name="l00952"></a>00952       }
<a name="l00953"></a>00953 
<a name="l00954"></a>00954       <span class="comment">// find minimal correct dimension to route through</span>
<a name="l00955"></a>00955       out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, rID);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957       <span class="comment">// if we haven&apos;t reached our destination, restrict VCs appropriately to avoid routing deadlock</span>
<a name="l00958"></a>00958       <span class="keywordflow">if</span>(out_port &gt;= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) {
<a name="l00959"></a>00959     <span class="keywordtype">int</span> <span class="keyword">const</span> available_vcs = (vcEnd - vcBegin + 1) / 2;
<a name="l00960"></a>00960     assert(available_vcs &gt; 0);
<a name="l00961"></a>00961     <span class="keywordflow">if</span>(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1) {
<a name="l00962"></a>00962       vcEnd -= available_vcs;
<a name="l00963"></a>00963     } <span class="keywordflow">else</span> {
<a name="l00964"></a>00964       assert(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 2);
<a name="l00965"></a>00965       vcBegin += available_vcs;
<a name="l00966"></a>00966     }
<a name="l00967"></a>00967       }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969       found = 1;
<a name="l00970"></a>00970     }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="keywordflow">if</span> (!found) {
<a name="l00973"></a>00973       cout &lt;&lt; <span class="stringliteral">&quot; ERROR: output not found in routing. &quot;</span> &lt;&lt; endl;
<a name="l00974"></a>00974       cout &lt;&lt; *f; exit (-1);
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="keywordflow">if</span> (out_port &gt;= <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>*(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1) + <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>)  {
<a name="l00978"></a>00978       cout &lt;&lt; <span class="stringliteral">&quot; ERROR: output port too big! &quot;</span> &lt;&lt; endl;
<a name="l00979"></a>00979       cout &lt;&lt; <span class="stringliteral">&quot; OUTPUT select: &quot;</span> &lt;&lt; out_port &lt;&lt; endl;
<a name="l00980"></a>00980       cout &lt;&lt; <span class="stringliteral">&quot; router radix: &quot;</span> &lt;&lt;  <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>*(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1) + <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a> &lt;&lt; endl;
<a name="l00981"></a>00981       exit (-1);
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984     <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot;        through output port : &quot;</span> &lt;&lt; out_port &lt;&lt; endl;
<a name="l00985"></a>00985     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>) {
<a name="l00986"></a>00986       cout&lt;&lt;<span class="stringliteral">&quot;Outport &quot;</span>&lt;&lt;out_port&lt;&lt;endl;
<a name="l00987"></a>00987       cout&lt;&lt;<span class="stringliteral">&quot;Stop Mark&quot;</span>&lt;&lt;endl;
<a name="l00988"></a>00988     }
<a name="l00989"></a>00989   }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l00992"></a>00992 
<a name="l00993"></a>00993   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="comment">// partially non-interfering (i.e., packets ordered by hash of destination) UGAL</span>
<a name="l00998"></a><a class="code" href="flatfly__onchip_8hpp.html#ab48e4cf1c461a89f4a752169768fcb40">00998</a> <span class="keywordtype">void</span> <a class="code" href="flatfly__onchip_8cpp.html#ab48e4cf1c461a89f4a752169768fcb40">ugal_pni_flatfly_onchip</a>( <span class="keyword">const</span> <a class="code" href="classRouter.html">Router</a> *r, <span class="keyword">const</span> <a class="code" href="structFlit.html">Flit</a> *f, <span class="keywordtype">int</span> in_channel,
<a name="l00999"></a>00999                   <a class="code" href="classOutputSet.html">OutputSet</a> *outputs, <span class="keywordtype">bool</span> inject )
<a name="l01000"></a>01000 {
<a name="l01001"></a>01001   <span class="comment">// ( Traffic Class , Routing Order ) -&gt; Virtual Channel Range</span>
<a name="l01002"></a>01002   <span class="keywordtype">int</span> vcBegin = 0, vcEnd = <a class="code" href="_2routefunc_8cpp.html#a4eaeeb1e41707b3b991f5be2c5def7b1">gNumVCs</a>-1;
<a name="l01003"></a>01003   <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ad47b8edbc7a6c26a34d782af584eeab0">Flit::READ_REQUEST</a> ) {
<a name="l01004"></a>01004     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a1426b2e997a3cca10e413c06a8a03385">gReadReqBeginVC</a>;
<a name="l01005"></a>01005     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a3b1c5a97b875eb008fe4e31601cd6622">gReadReqEndVC</a>;
<a name="l01006"></a>01006   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> == <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a74c1c54b3ebc54205b6a3e160ac2d0da">Flit::WRITE_REQUEST</a> ) {
<a name="l01007"></a>01007     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4c6e6e9ca6b8f7909946f094163a9f60">gWriteReqBeginVC</a>;
<a name="l01008"></a>01008     vcEnd = <a class="code" href="_2routefunc_8cpp.html#af22408f73cdec35a9b055197155502d9">gWriteReqEndVC</a>;
<a name="l01009"></a>01009   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81a18d4c2af84d9556279434e5134b6c0bf">Flit::READ_REPLY</a> ) {
<a name="l01010"></a>01010     vcBegin = <a class="code" href="_2routefunc_8cpp.html#ad6eb81a102eeb4432b93326c25d84c04">gReadReplyBeginVC</a>;
<a name="l01011"></a>01011     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a05e9946de6943572ff364fdceff44c9d">gReadReplyEndVC</a>;
<a name="l01012"></a>01012   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structFlit.html#a4f56cca863f428c79260a517cadc244a">type</a> ==  <a class="code" href="structFlit.html#a2ff557df3aca49c49a1e49e00cd3ec81ae6c1481b97213d1e4476cbc48d40f615">Flit::WRITE_REPLY</a> ) {
<a name="l01013"></a>01013     vcBegin = <a class="code" href="_2routefunc_8cpp.html#a4b8dbe2d2099727b7cc58b80a85fdd83">gWriteReplyBeginVC</a>;
<a name="l01014"></a>01014     vcEnd = <a class="code" href="_2routefunc_8cpp.html#a8be251594be99415185588912b330add">gWriteReplyEndVC</a>;
<a name="l01015"></a>01015   }
<a name="l01016"></a>01016   assert(((f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &gt;= vcBegin) &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt;= vcEnd)) || (inject &amp;&amp; (f-&gt;<a class="code" href="structFlit.html#a91f87fc20463a5fe6ea5e9e035991701">vc</a> &lt; 0)));
<a name="l01017"></a>01017 
<a name="l01018"></a>01018   <span class="keywordtype">int</span> out_port;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020   <span class="keywordflow">if</span>(inject) {
<a name="l01021"></a>01021     
<a name="l01022"></a>01022     out_port = -1;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024   } <span class="keywordflow">else</span> {
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     <span class="keywordtype">int</span> dest  = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="keywordtype">int</span> rID =  r-&gt;<a class="code" href="classRouter.html#ab489e7e2e0a687dc7e0bea78afb2794a">GetID</a>();
<a name="l01029"></a>01029     <span class="keywordtype">int</span> _concentration = <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01030"></a>01030     <span class="keywordtype">int</span> found;
<a name="l01031"></a>01031     <span class="keywordtype">int</span> debug = 0;
<a name="l01032"></a>01032     <span class="keywordtype">int</span> tmp_out_port, _ran_intm;
<a name="l01033"></a>01033     <span class="keywordtype">int</span> _min_hop, _nonmin_hop, _min_queucnt, _nonmin_queucnt;
<a name="l01034"></a>01034     <span class="keywordtype">int</span> threshold = 2;
<a name="l01035"></a>01035 
<a name="l01036"></a>01036     <span class="keywordflow">if</span> ( in_channel &lt; <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> ){
<a name="l01037"></a>01037       <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l01038"></a>01038     cout&lt;&lt;<span class="stringliteral">&quot;New Flit &quot;</span>&lt;&lt;f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>&lt;&lt;endl;
<a name="l01039"></a>01039       }
<a name="l01040"></a>01040       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a>   = 0;
<a name="l01041"></a>01041     }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>){
<a name="l01044"></a>01044       <span class="keywordtype">int</span> load = 0;
<a name="l01045"></a>01045       cout&lt;&lt;<span class="stringliteral">&quot;Router &quot;</span>&lt;&lt;rID&lt;&lt;endl;
<a name="l01046"></a>01046       cout&lt;&lt;<span class="stringliteral">&quot;Input Channel &quot;</span>&lt;&lt;in_channel&lt;&lt;endl;
<a name="l01047"></a>01047       <span class="comment">//need to modify router to report the buffere depth</span>
<a name="l01048"></a>01048       load +=r-&gt;<a class="code" href="classRouter.html#a6c8ced6034de23b954643d8b18b3e52c">GetBufferOccupancy</a>(in_channel);
<a name="l01049"></a>01049       cout&lt;&lt;<span class="stringliteral">&quot;Rload &quot;</span>&lt;&lt;load&lt;&lt;endl;
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052     <span class="keywordflow">if</span> (debug){
<a name="l01053"></a>01053       cout &lt;&lt; <span class="stringliteral">&quot; FLIT ID: &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#aeae7d176eaa77ba7300abee6afbee8a4">id</a> &lt;&lt; <span class="stringliteral">&quot; Router: &quot;</span> &lt;&lt; rID &lt;&lt; <span class="stringliteral">&quot; routing from src : &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a> &lt;&lt;  <span class="stringliteral">&quot; to dest : &quot;</span> &lt;&lt; dest &lt;&lt; <span class="stringliteral">&quot; f-&gt;ph: &quot;</span> &lt;&lt;f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> &lt;&lt; <span class="stringliteral">&quot; intm: &quot;</span> &lt;&lt; f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> &lt;&lt;  endl;
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055     <span class="comment">// f-&gt;ph == 0  ==&gt; make initial global adaptive decision</span>
<a name="l01056"></a>01056     <span class="comment">// f-&gt;ph == 1  ==&gt; route nonminimaly to random intermediate node</span>
<a name="l01057"></a>01057     <span class="comment">// f-&gt;ph == 2  ==&gt; route minimally to destination</span>
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     found = 0;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1){
<a name="l01062"></a>01062       dest = f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>;
<a name="l01063"></a>01063     }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="keywordflow">if</span> (dest &gt;= rID*_concentration &amp;&amp; dest &lt; (rID+1)*_concentration) {
<a name="l01067"></a>01067 
<a name="l01068"></a>01068       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1) {
<a name="l01069"></a>01069     f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l01070"></a>01070     dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l01071"></a>01071     <span class="keywordflow">if</span> (debug)   cout &lt;&lt; <span class="stringliteral">&quot;      done routing to intermediate &quot;</span>;
<a name="l01072"></a>01072       }
<a name="l01073"></a>01073       <span class="keywordflow">else</span>  {
<a name="l01074"></a>01074     found = 1;
<a name="l01075"></a>01075     out_port = dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (debug)   cout &lt;&lt; <span class="stringliteral">&quot;      final routing to destination &quot;</span>;
<a name="l01077"></a>01077       }
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="keywordflow">if</span> (!found) {
<a name="l01081"></a>01081 
<a name="l01082"></a>01082       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 0) {
<a name="l01083"></a>01083     _min_hop = <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>),dest);
<a name="l01084"></a>01084     _ran_intm = <a class="code" href="flatfly__onchip_8cpp.html#acad64c555069654f1f3152d66e92a6bf">find_ran_intm</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>), dest);
<a name="l01085"></a>01085     tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, rID);
<a name="l01086"></a>01086     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#aa5328bdf6d139ea1c8e503228bf8aae5">watch</a>){
<a name="l01087"></a>01087       *<a class="code" href="globals_8hpp.html#a54233075d19c60edbe29257351f7fe3d">gWatchOut</a> &lt;&lt; <a class="code" href="globals_8hpp.html#ad223077827fd15227dc1bd007980a296">GetSimTime</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span> &lt;&lt; r-&gt;<a class="code" href="classModule.html#a0eeaa2b9a7d2ba88ab05682444898b08">FullName</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span>
<a name="l01088"></a>01088              &lt;&lt; <span class="stringliteral">&quot; MIN tmp_out_port: &quot;</span> &lt;&lt; tmp_out_port;
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     _min_queucnt =   r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(tmp_out_port);
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     _nonmin_hop = <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(<a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#afab57916724fd9bd87f2450f571a855f">src</a>),_ran_intm) +    <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a>(_ran_intm, dest);
<a name="l01094"></a>01094     tmp_out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(_ran_intm, rID);
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structFlit.html#aa5328bdf6d139ea1c8e503228bf8aae5">watch</a>){
<a name="l01097"></a>01097       *<a class="code" href="globals_8hpp.html#a54233075d19c60edbe29257351f7fe3d">gWatchOut</a> &lt;&lt; <a class="code" href="globals_8hpp.html#ad223077827fd15227dc1bd007980a296">GetSimTime</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span> &lt;&lt; r-&gt;<a class="code" href="classModule.html#a0eeaa2b9a7d2ba88ab05682444898b08">FullName</a>() &lt;&lt; <span class="stringliteral">&quot; | &quot;</span>
<a name="l01098"></a>01098              &lt;&lt; <span class="stringliteral">&quot; NONMIN tmp_out_port: &quot;</span> &lt;&lt; tmp_out_port &lt;&lt; endl;
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100     <span class="keywordflow">if</span> (_ran_intm &gt;= rID*_concentration &amp;&amp; _ran_intm &lt; (rID+1)*_concentration) {
<a name="l01101"></a>01101       _nonmin_queucnt = numeric_limits&lt;int&gt;::max();
<a name="l01102"></a>01102     } <span class="keywordflow">else</span>  {
<a name="l01103"></a>01103       _nonmin_queucnt =   r-&gt;<a class="code" href="classRouter.html#a6dbf542acf1ee5d568ccc0325904821f">GetUsedCredit</a>(tmp_out_port);
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <span class="keywordflow">if</span> (debug){
<a name="l01107"></a>01107       cout &lt;&lt; <span class="stringliteral">&quot; _min_hop &quot;</span> &lt;&lt; _min_hop &lt;&lt; <span class="stringliteral">&quot; _min_queucnt: &quot;</span> &lt;&lt;_min_queucnt &lt;&lt; <span class="stringliteral">&quot; _nonmin_hop: &quot;</span> &lt;&lt; _nonmin_hop &lt;&lt; <span class="stringliteral">&quot; _nonmin_queucnt :&quot;</span> &lt;&lt; _nonmin_queucnt &lt;&lt;  endl;
<a name="l01108"></a>01108     }
<a name="l01109"></a>01109 
<a name="l01110"></a>01110     <span class="keywordflow">if</span> (_min_hop * _min_queucnt   &lt;= _nonmin_hop * _nonmin_queucnt +threshold) {
<a name="l01111"></a>01111 
<a name="l01112"></a>01112       <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot; Route MINIMALLY &quot;</span> &lt;&lt; endl;
<a name="l01113"></a>01113       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l01114"></a>01114     } <span class="keywordflow">else</span> {
<a name="l01115"></a>01115       <span class="comment">// route non-minimally</span>
<a name="l01116"></a>01116       <span class="keywordflow">if</span> (debug)  { cout &lt;&lt; <span class="stringliteral">&quot; Route NONMINIMALLY int node: &quot;</span> &lt;&lt;_ran_intm &lt;&lt; endl; }
<a name="l01117"></a>01117       f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 1;
<a name="l01118"></a>01118       f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a> = _ran_intm;
<a name="l01119"></a>01119       dest = f-&gt;<a class="code" href="structFlit.html#adc90408e524850a0ff3a39fda83a2b65">intm</a>;
<a name="l01120"></a>01120       <span class="keywordflow">if</span> (dest &gt;= rID*_concentration &amp;&amp; dest &lt; (rID+1)*_concentration) {
<a name="l01121"></a>01121         f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> = 2;
<a name="l01122"></a>01122         dest = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l01123"></a>01123       }
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125       }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127       <span class="comment">// find minimal correct dimension to route through</span>
<a name="l01128"></a>01128       out_port =  <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(dest, rID);
<a name="l01129"></a>01129 
<a name="l01130"></a>01130       <span class="comment">// if we haven&apos;t reached our destination, restrict VCs appropriately to avoid routing deadlock</span>
<a name="l01131"></a>01131       <span class="keywordflow">if</span>(out_port &gt;= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) {
<a name="l01132"></a>01132     <span class="keywordtype">int</span> <span class="keyword">const</span> available_vcs = (vcEnd - vcBegin + 1) / 2;
<a name="l01133"></a>01133     assert(available_vcs &gt; 0);
<a name="l01134"></a>01134     <span class="keywordflow">if</span>(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1) {
<a name="l01135"></a>01135       vcEnd -= available_vcs;
<a name="l01136"></a>01136     } <span class="keywordflow">else</span> {
<a name="l01137"></a>01137       assert(f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 2);
<a name="l01138"></a>01138       vcBegin += available_vcs;
<a name="l01139"></a>01139     }
<a name="l01140"></a>01140       }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142       found = 1;
<a name="l01143"></a>01143     }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145     <span class="keywordflow">if</span> (!found) {
<a name="l01146"></a>01146       cout &lt;&lt; <span class="stringliteral">&quot; ERROR: output not found in routing. &quot;</span> &lt;&lt; endl;
<a name="l01147"></a>01147       cout &lt;&lt; *f; exit (-1);
<a name="l01148"></a>01148     }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (out_port &gt;= <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>*(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1) + <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>)  {
<a name="l01151"></a>01151       cout &lt;&lt; <span class="stringliteral">&quot; ERROR: output port too big! &quot;</span> &lt;&lt; endl;
<a name="l01152"></a>01152       cout &lt;&lt; <span class="stringliteral">&quot; OUTPUT select: &quot;</span> &lt;&lt; out_port &lt;&lt; endl;
<a name="l01153"></a>01153       cout &lt;&lt; <span class="stringliteral">&quot; router radix: &quot;</span> &lt;&lt;  <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>*(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1) + <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a> &lt;&lt; endl;
<a name="l01154"></a>01154       exit (-1);
<a name="l01155"></a>01155     }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot;        through output port : &quot;</span> &lt;&lt; out_port &lt;&lt; endl;
<a name="l01158"></a>01158     <span class="keywordflow">if</span>(<a class="code" href="globals_8hpp.html#a35b664146e55660800a67a648cf6748d">gTrace</a>) {
<a name="l01159"></a>01159       cout&lt;&lt;<span class="stringliteral">&quot;Outport &quot;</span>&lt;&lt;out_port&lt;&lt;endl;
<a name="l01160"></a>01160       cout&lt;&lt;<span class="stringliteral">&quot;Stop Mark&quot;</span>&lt;&lt;endl;
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162   }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164   <span class="keywordflow">if</span>(inject || (out_port &gt;= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>)) {
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     <span class="comment">// NOTE: for &quot;proper&quot; flattened butterfly configurations (i.e., ones </span>
<a name="l01167"></a>01167     <span class="comment">// derived from flattening an actual butterfly), gK and gC are the same!</span>
<a name="l01168"></a>01168     assert(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a> == <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170     assert(inject ? (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == -1) : (f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 1 || f-&gt;<a class="code" href="structFlit.html#af6a90cc5a3a24d46b2e166871f252c16">ph</a> == 2));
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="keywordtype">int</span> next_coord = <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(f-&gt;<a class="code" href="structFlit.html#a89d05814b6f9dcd035ec002a7ea00c57">dest</a>);
<a name="l01173"></a>01173     <span class="keywordflow">if</span>(inject) {
<a name="l01174"></a>01174       next_coord /= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01175"></a>01175       next_coord %= <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>;
<a name="l01176"></a>01176     } <span class="keywordflow">else</span> {
<a name="l01177"></a>01177       <span class="keywordtype">int</span> next_dim = (out_port - <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>) / (<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a> - 1) + 1;
<a name="l01178"></a>01178       <span class="keywordflow">if</span>(next_dim == <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>) {
<a name="l01179"></a>01179     next_coord %= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01180"></a>01180       } <span class="keywordflow">else</span> {
<a name="l01181"></a>01181     next_coord /= <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01182"></a>01182     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> d = 0; d &lt; next_dim; ++d) {
<a name="l01183"></a>01183       next_coord /= <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>;
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185     next_coord %= <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>;
<a name="l01186"></a>01186       }
<a name="l01187"></a>01187     }
<a name="l01188"></a>01188     assert(next_coord &gt;= 0 &amp;&amp; next_coord &lt; <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01189"></a>01189     <span class="keywordtype">int</span> vcs_per_dest = (vcEnd - vcBegin + 1) / <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>;
<a name="l01190"></a>01190     assert(vcs_per_dest &gt; 0);
<a name="l01191"></a>01191     vcBegin += next_coord * vcs_per_dest;
<a name="l01192"></a>01192     vcEnd = vcBegin + vcs_per_dest - 1;
<a name="l01193"></a>01193   }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195   outputs-&gt;<a class="code" href="classOutputSet.html#a6bfd3bb1f62d8fe65b981e6bc25fd241">Clear</a>( );
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   outputs-&gt;<a class="code" href="classOutputSet.html#a5cc16a2724fb2962a0060d2973e011de">AddRange</a>( out_port , vcBegin, vcEnd );
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 
<a name="l01201"></a>01201 <span class="comment">//=============================================================^M</span>
<a name="l01202"></a>01202 <span class="comment">// UGAL : calculate distance (hop cnt)  between src and destination</span>
<a name="l01203"></a>01203 <span class="comment">//=============================================================^M</span>
<a name="l01204"></a><a class="code" href="flatfly__onchip_8hpp.html#ad9290881b9e84b68edbd9bac3d5662c8">01204</a> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#ad9290881b9e84b68edbd9bac3d5662c8">find_distance</a> (<span class="keywordtype">int</span> src, <span class="keywordtype">int</span> dest) {
<a name="l01205"></a>01205   <span class="keywordtype">int</span> dist = 0;
<a name="l01206"></a>01206   <span class="keywordtype">int</span> _dim   = <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>;
<a name="l01207"></a>01207   <span class="keywordtype">int</span> _dim_size;
<a name="l01208"></a>01208   
<a name="l01209"></a>01209   <span class="keywordtype">int</span> src_tmp= (<a class="code" href="classint.html">int</a>) src / <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01210"></a>01210   <span class="keywordtype">int</span> dest_tmp = (<a class="code" href="classint.html">int</a>) dest / <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01211"></a>01211   <span class="keywordtype">int</span> src_id, dest_id;
<a name="l01212"></a>01212   
<a name="l01213"></a>01213   <span class="comment">//  cout &lt;&lt; &quot; HOP CNT between  src: &quot; &lt;&lt; src &lt;&lt; &quot; dest: &quot; &lt;&lt; dest;</span>
<a name="l01214"></a>01214   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d=0;d &lt; _dim; d++) {
<a name="l01215"></a>01215     _dim_size = <a class="code" href="misc__utils_8cpp.html#add89cd3058e518c99a645eff11531afa">powi</a>(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>, d )*<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01216"></a>01216     <span class="comment">//if ((int)(src / _dim_size) !=  (int)(dest / _dim_size))</span>
<a name="l01217"></a>01217     <span class="comment">//   dist++;</span>
<a name="l01218"></a>01218     src_id = src_tmp % <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>;
<a name="l01219"></a>01219     dest_id = dest_tmp % <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>;
<a name="l01220"></a>01220     <span class="keywordflow">if</span> (src_id !=  dest_id)
<a name="l01221"></a>01221       dist++;
<a name="l01222"></a>01222     src_tmp = (<a class="code" href="classint.html">int</a>) (src_tmp / <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01223"></a>01223     dest_tmp = (<a class="code" href="classint.html">int</a>) (dest_tmp / <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01224"></a>01224   }
<a name="l01225"></a>01225   
<a name="l01226"></a>01226   <span class="comment">//  cout &lt;&lt; &quot; : &quot; &lt;&lt; dist &lt;&lt; endl;</span>
<a name="l01227"></a>01227   
<a name="l01228"></a>01228   <span class="keywordflow">return</span> dist;
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 <span class="comment">//=============================================================^M</span>
<a name="l01232"></a>01232 <span class="comment">// UGAL : find random node for load balancing</span>
<a name="l01233"></a>01233 <span class="comment">//=============================================================^M</span>
<a name="l01234"></a><a class="code" href="flatfly__onchip_8hpp.html#acad64c555069654f1f3152d66e92a6bf">01234</a> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#acad64c555069654f1f3152d66e92a6bf">find_ran_intm</a> (<span class="keywordtype">int</span> src, <span class="keywordtype">int</span> dest) {
<a name="l01235"></a>01235   <span class="keywordtype">int</span> _dim   = <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>;
<a name="l01236"></a>01236   <span class="keywordtype">int</span> _dim_size;
<a name="l01237"></a>01237   <span class="keywordtype">int</span> _ran_dest = 0;
<a name="l01238"></a>01238   <span class="keywordtype">int</span> debug = 0;
<a name="l01239"></a>01239   
<a name="l01240"></a>01240   <span class="keywordflow">if</span> (debug) 
<a name="l01241"></a>01241     cout &lt;&lt; <span class="stringliteral">&quot; INTM node for  src: &quot;</span> &lt;&lt; src &lt;&lt; <span class="stringliteral">&quot; dest: &quot;</span> &lt;&lt;dest &lt;&lt; endl;
<a name="l01242"></a>01242   
<a name="l01243"></a>01243   src = (<a class="code" href="classint.html">int</a>) (src / <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l01244"></a>01244   dest = (<a class="code" href="classint.html">int</a>) (dest / <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l01245"></a>01245   
<a name="l01246"></a>01246   _ran_dest = <a class="code" href="random__utils_8cpp.html#ac46ec4a8515ceccca7c472ee3687b83f">RandomInt</a>(<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> - 1);
<a name="l01247"></a>01247   <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot; ............ _ran_dest : &quot;</span> &lt;&lt; _ran_dest &lt;&lt; endl;
<a name="l01248"></a>01248   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d=0;d &lt; _dim; d++) {
<a name="l01249"></a>01249     
<a name="l01250"></a>01250     _dim_size = <a class="code" href="misc__utils_8cpp.html#add89cd3058e518c99a645eff11531afa">powi</a>(<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>, d)*<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01251"></a>01251     <span class="keywordflow">if</span> ((src % <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>) ==  (dest % gK)) {
<a name="l01252"></a>01252       _ran_dest += (src % gK) * _dim_size;
<a name="l01253"></a>01253       <span class="keywordflow">if</span> (debug) 
<a name="l01254"></a>01254     cout &lt;&lt; <span class="stringliteral">&quot;    share same dimension : &quot;</span> &lt;&lt; d &lt;&lt; <span class="stringliteral">&quot; int node : &quot;</span> &lt;&lt; _ran_dest &lt;&lt; <span class="stringliteral">&quot; src ID : &quot;</span> &lt;&lt; src % gK &lt;&lt; endl;
<a name="l01255"></a>01255     } <span class="keywordflow">else</span> {
<a name="l01256"></a>01256       <span class="comment">// src and dest are in the same dimension &quot;d&quot; + 1</span>
<a name="l01257"></a>01257       <span class="comment">// ==&gt; thus generate a random destination within</span>
<a name="l01258"></a>01258       _ran_dest += <a class="code" href="random__utils_8cpp.html#ac46ec4a8515ceccca7c472ee3687b83f">RandomInt</a>(gK - 1) * _dim_size;
<a name="l01259"></a>01259       <span class="keywordflow">if</span> (debug) 
<a name="l01260"></a>01260     cout &lt;&lt; <span class="stringliteral">&quot;    different  dimension : &quot;</span> &lt;&lt; d &lt;&lt; <span class="stringliteral">&quot; int node : &quot;</span> &lt;&lt; _ran_dest &lt;&lt; <span class="stringliteral">&quot; _dim_size: &quot;</span> &lt;&lt; _dim_size &lt;&lt; endl;
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262     src = (<a class="code" href="classint.html">int</a>) (src / gK);
<a name="l01263"></a>01263     dest = (<a class="code" href="classint.html">int</a>) (dest / gK);
<a name="l01264"></a>01264   }
<a name="l01265"></a>01265   
<a name="l01266"></a>01266   <span class="keywordflow">if</span> (debug) cout &lt;&lt; <span class="stringliteral">&quot; intermediate destination NODE: &quot;</span> &lt;&lt; _ran_dest &lt;&lt; endl;
<a name="l01267"></a>01267   <span class="keywordflow">return</span> _ran_dest;
<a name="l01268"></a>01268 }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270 
<a name="l01271"></a>01271 
<a name="l01272"></a>01272 <span class="comment">//=============================================================</span>
<a name="l01273"></a>01273 <span class="comment">// UGAL : calculated minimum distance output port for flatfly</span>
<a name="l01274"></a>01274 <span class="comment">// given the dimension and destination</span>
<a name="l01275"></a>01275 <span class="comment">//=============================================================</span>
<a name="l01276"></a>01276 <span class="comment">// starting from DIM 0 (x first)</span>
<a name="l01277"></a><a class="code" href="flatfly__onchip_8hpp.html#af70e30547a18836edf0473d2183fddc7">01277</a> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#af70e30547a18836edf0473d2183fddc7">flatfly_outport</a>(<span class="keywordtype">int</span> dest, <span class="keywordtype">int</span> rID) {
<a name="l01278"></a>01278   <span class="keywordtype">int</span> dest_rID = (<a class="code" href="classint.html">int</a>) (dest / <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>);
<a name="l01279"></a>01279   <span class="keywordtype">int</span> _dim   = <a class="code" href="network_8cpp.html#aee153dc531210949c222c5de2809a52f">gN</a>;
<a name="l01280"></a>01280   <span class="keywordtype">int</span> <a class="code" href="cuobjdump__to__ptxplus_8cc.html#a850af8cfb632548b213ce5b365fedd1a">output</a> = -1, dID, sID;
<a name="l01281"></a>01281   
<a name="l01282"></a>01282   <span class="keywordflow">if</span>(dest_rID==rID){
<a name="l01283"></a>01283     <span class="keywordflow">return</span> dest % <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>;
<a name="l01284"></a>01284   }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286 
<a name="l01287"></a>01287   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d=0;d &lt; _dim; d++) {
<a name="l01288"></a>01288     dID = (dest_rID % <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01289"></a>01289     sID = (rID % <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01290"></a>01290     <span class="keywordflow">if</span> ( dID != sID ) {
<a name="l01291"></a>01291       output = <a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a> + ((<a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>-1)*d) - 1;
<a name="l01292"></a>01292       <span class="keywordflow">if</span> (dID &gt; sID) {
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     output += dID;
<a name="l01295"></a>01295       } <span class="keywordflow">else</span> {
<a name="l01296"></a>01296     output += dID + 1;
<a name="l01297"></a>01297       }
<a name="l01298"></a>01298       
<a name="l01299"></a>01299       <span class="keywordflow">return</span> output;
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301     dest_rID = (<a class="code" href="classint.html">int</a>) (dest_rID / <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01302"></a>01302     rID      = (<a class="code" href="classint.html">int</a>) (rID / <a class="code" href="network_8cpp.html#ae2fee33ea73579a2cace995cd9dcf0eb">gK</a>);
<a name="l01303"></a>01303   }
<a name="l01304"></a>01304   <span class="keywordflow">if</span> (output == -1) {
<a name="l01305"></a>01305     cout &lt;&lt; <span class="stringliteral">&quot; ERROR ---- FLATFLY_OUTPORT function : output not found &quot;</span> &lt;&lt; endl;
<a name="l01306"></a>01306     exit(-1);
<a name="l01307"></a>01307   }
<a name="l01308"></a>01308   <span class="keywordflow">return</span> -1;
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a><a class="code" href="flatfly__onchip_8hpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">01311</a> <span class="keywordtype">int</span> <a class="code" href="flatfly__onchip_8cpp.html#a24e2eef9a85744a6ddc58cd8e4c55fc7">flatfly_transformation</a>(<span class="keywordtype">int</span> dest){
<a name="l01312"></a>01312   <span class="comment">//the magic of destination transformation</span>
<a name="l01313"></a>01313 
<a name="l01314"></a>01314   <span class="comment">//destination transformation, translate how the nodes are actually arranged</span>
<a name="l01315"></a>01315   <span class="comment">//to the easier way of routing</span>
<a name="l01316"></a>01316   <span class="comment">//this transformation only support 64 nodes</span>
<a name="l01317"></a>01317 
<a name="l01318"></a>01318   <span class="comment">//cout&lt;&lt;&quot;ORiginal destination &quot;&lt;&lt;dest&lt;&lt;endl;</span>
<a name="l01319"></a>01319   <span class="comment">//router in the x direction = find which column, and then mod by cY to find </span>
<a name="l01320"></a>01320   <span class="comment">//which horizontal router</span>
<a name="l01321"></a>01321   <span class="keywordtype">int</span> horizontal = (dest%(_xcount*_xrouter))/(_xrouter);
<a name="l01322"></a>01322   <span class="keywordtype">int</span> horizontal_rem = (dest%(_xcount*_xrouter))%(_xrouter);
<a name="l01323"></a>01323   <span class="comment">//router in the y direction = find which row, and then divided by cX to find </span>
<a name="l01324"></a>01324   <span class="comment">//vertical router</span>
<a name="l01325"></a>01325   <span class="keywordtype">int</span> vertical = (dest/(_xcount*_xrouter))/(_yrouter);
<a name="l01326"></a>01326   <span class="keywordtype">int</span> vertical_rem = (dest/(_xcount*_xrouter))%(_yrouter);
<a name="l01327"></a>01327   <span class="comment">//transform the destination to as if node0 was 0,1,2,3 and so forth</span>
<a name="l01328"></a>01328   dest = (vertical*_xcount + horizontal)*<a class="code" href="globals_8hpp.html#a22d883cf2c34916f73300e6a08437703">gC</a>+_xrouter*vertical_rem+horizontal_rem;
<a name="l01329"></a>01329   <span class="comment">//cout&lt;&lt;&quot;Transformed destination &quot;&lt;&lt;dest&lt;&lt;endl&lt;&lt;endl;</span>
<a name="l01330"></a>01330   <span class="keywordflow">return</span> dest;
<a name="l01331"></a>01331 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 13 May 2014 for GPGPU-Sim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
